<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[24516] OSG 3.2.21 broke SLURM gratia probe</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <link href="https://ticket.opensciencegrid.org/rss" rel="alternate" type="application/rss+xml" title="GOC Ticket Update feed" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=24516" method="post">
<div class="page-header">
    <h3><span class="muted">24516</span> / OSG 3.2.21 broke SLURM gratia probe</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">John Dockendorf</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    <div class="control-group"><label class="control-label">Submitted Via</label><div class="controls">GOC Ticket/submit</div></div><div class="control-group"><label class="control-label">Submitter</label><div class="controls">John Dockendorf</div></div>
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls">Resolved</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2015-04-08</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Software Support (Triage) <span class="muted"> / OSG Software Team</span></div><div class="assignee" style="width: 60%">Carl Edquist <span class="muted"> / OSG Software Team</span></div><div class="assignee" style="width: 60%">Suchandra Thapa <span class="muted"> / OSG Software Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/24516", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src=\""+this.thumbnail_url+"\"/></td>";
            html += "<td><a href=\""+this.url+"\" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='24516#1432318322'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-05-22T18:12:02+00:00">May 22, 2015 06:12 PM UTC</time><a class="anchor" name="1432318322">&nbsp;</a></div><pre>So I&#39;m getting emails from cron again that this same error is occurring.

SELECT id_job, time_end, time_start, time_suspended FROM brazos_job_table WHERE time_end &#60; time_start + time_suspended

The above returns 1244 records.  The squeue output shows 1169 jobs running and 70 suspended.

Let me know what I can do to debug this further, if I should open a new ticket or if this may have been resolved in a recent update.

Thanks,
- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1428439772'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-07T20:49:32+00:00">Apr 7, 2015 08:49 PM UTC</time> by <b>Vince Neal</b><a class="anchor" name="1428439772">&nbsp;</a></div><pre>Thank you for informing us that this issue has been resolved. I will close this ticket.  Please submit problems, requests, and questions at&#58; <a href='https&#58;//ticket.grid.iu.edu/goc/open' target='_blank' rel='nofollow'>https&#58;//ticket.grid.iu.edu/goc/open</a> OSG Grid Operations Center goc@...., 317-278-9699 Visit the OSG Operations Page&#58; <a href='http&#58;//osggoc.blogspot.com/' target='_blank' rel='nofollow'>http&#58;//osggoc.blogspot.com/</a></pre></div><div class='update_description'><i onclick="document.location='24516#1428436679'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-07T19:57:59+00:00">Apr 7, 2015 07:57 PM UTC</time><a class="anchor" name="1428436679">&nbsp;</a></div><pre>I haven&#39;t seen any more error alerts since the initial report.  Whatever the cause it was temporary.   I&#39;m fine with this ticket being closed.  Handling fringe cases may be good, especially if they relate to differences that are inherit with MySQL 5.5.5+ as that is the default version of MySQL/MariaDB shipped with EL7.

- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1428433020'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-07T18:57:00+00:00">Apr 7, 2015 06:57 PM UTC</time> by <b>Carl Edquist</b><a class="anchor" name="1428433020">&nbsp;</a></div><pre>Interesting, ok...  So since then you haven&#39;t seen any more error alerts?  If that&#39;s the case, should we close this ticket?

Otherwise we can update sql query in the slurm probe to handle this edge case.

Thanks,
Carl</pre></div><div class='update_description'><i onclick="document.location='24516#1428340201'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-06T17:10:01+00:00">Apr 6, 2015 05:10 PM UTC</time><a class="anchor" name="1428340201">&nbsp;</a></div><pre>Carl,

The version of MariaDB used has been the same since we started using SLURM which was production for our site around October of 2014.  The only change that occurred when the backtrace happened was the update to the OSG software stack on our CE.  It could be a coincidence that the OSG updates also happened when some set of data was in the brazos_job_table that caused the gratia probe to throw exceptions.

- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1428025177'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-03T01:39:37+00:00">Apr 3, 2015 01:39 AM UTC</time> by <b>Carl Edquist</b><a class="anchor" name="1428025177">&nbsp;</a></div><pre>Thanks Trey for the info,

So apparently this &#34;value is out of range&#34; condition only gets hit for jobs still running (with time_end = 0) ...

I am trying to follow the footprints in the slurm probe...  My current theory is we can hit this condition if there are multiple entries in the job table (brazos_job_table) for the same id_job value (maybe that means it was preempted and resumed?), and at least one of them &#34;finished&#34; with time_end &#62; the checkpoint time, but at least one of them is also still currently running (time_end = 0).

I&#39;m basing it off the &#39;where&#39; and &#39;having&#39; clauses used for the completed_jobs query, which is where the error happened for you based on your backtrace&#58;

File &#34;/usr/share/gratia/slurm/slurm_meter&#34;, line 217, in main
for job in self.sacct.completed_jobs(self.checkpoint.val)&#58;

<font color='#7F7E6F'>&#62;   def completed_jobs(self, ts)&#58;</font>
<font color='#7F7E6F'>&#62;       &#34;&#34;&#34;Completed jobs, ordered by completion time&#34;&#34;&#34;</font>
<font color='#7F7E6F'>&#62;</font>
<font color='#7F7E6F'>&#62;       # We need *all* job_table records for jobs which completed inside the</font>
<font color='#7F7E6F'>&#62;       # time range. This needs to include jobs which were preempted and</font>
<font color='#7F7E6F'>&#62;       # resumed.</font>
<font color='#7F7E6F'>&#62;       where = &#39;&#39;&#39;id_job IN (</font>
<font color='#7F7E6F'>&#62;               SELECT id_job FROM %(cluster)s_job_table</font>
<font color='#7F7E6F'>&#62;               WHERE time_start &#62; 0 AND time_end &#62;= %(end)s</font>
<font color='#7F7E6F'>&#62;           )</font>
<font color='#7F7E6F'>&#62;       &#39;&#39;&#39; % { &#39;cluster&#39;&#58; self._cluster, &#39;end&#39;&#58; long(ts) }</font>
<font color='#7F7E6F'>&#62;</font>
<font color='#7F7E6F'>&#62;       # The job is not running and has not been requeued</font>
<font color='#7F7E6F'>&#62;       having = &#39;MIN(j.time_end) &#62; 0 AND MIN(j.time_start) &#62; 0&#39;</font>
<font color='#7F7E6F'>&#62;</font>
<font color='#7F7E6F'>&#62;       return self._jobs(where, having)</font>

in that case, there would be at least one time_end=0 getting evaluated in the wall_time expression, which would hit the &#34;value is out of range&#34; error, at least on mysql 5.5.5+ (and, I&#39;m guessing mariadb also).  In previous versions of mysql, the wall_time for the running jobs would have wrapped around to be a huge value, but the MIN(j.time_end) in the &#39;having&#39; clause would have filtered them out after the fact for this completed_jobs query.  But it&#39;s an error in mysql 5.5.5 because the &#39;having&#39; clause gets applied later, after the wrap-around value gets evaluated.

So (guessing) the &#34;-s 900&#34; parameter might be a red herring.

Not sure how easy it would be to try to reproduce this kind of scenario to confirm it always gets the error.

Did the mariadb-5.5.37 update happen recently also?
<div id='show_325852413' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_325852413'>
If this is really the problem, then it&#39;s probably specific to mysql/mariadb &#62;= 5.5.5, but in any case we (the osg software team) need to fix it, which should hopefully be pretty straightforward.

Thanks!
Carl
</div><script type='text/javascript'>
        $('#show_325852413').click(function() {
            $('#detail_325852413').slideDown("normal");
            $('#show_325852413').hide();
            $('#hide_325852413').show();
        });
        $('#hide_325852413').click(function() {
            $('#detail_325852413').slideUp();
            $('#hide_325852413').hide();
            $('#show_325852413').show();
        });
        </script></pre></div><div class='update_description'><i onclick="document.location='24516#1428019320'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-03T00:02:00+00:00">Apr 3, 2015 12:02 AM UTC</time><a class="anchor" name="1428019320">&nbsp;</a></div><pre>I&#39;ve received dozens of emails from cron run SLURM probe, all with healthy output.  I also checked the gratia accounting in MyOSG and our site has data.  I went through the mail for root on our CE and found that at 06&#58;05 CST on March 28th the messages to the inbox stopped.  What&#39;s odd is I don&#39;t see any gaps of gratia data in MySQL from when these errors were occurring.

I ran the SQL query &#34;SELECT id_job, time_end, time_start, time_suspended FROM brazos_job_table WHERE time_end &#60; time_start + time_suspended&#34; and it returned 336 records and I confirmed that SLURM currently has 336 jobs running.  If I add &#34;AND time_end &#62; 0&#34; then no records are returned.

The system running our SLURM MySQL database is CentOS 7 which is currently mariadb-5.5.37.

Below is the &#34;describe brazos_job_table&#34; output.  If the error occurs again I&#39;m going to see if I can modify the cron file to selectively capture the debug output when the slurm_meter command fails.

+----------------+----------------------+------+-----+---------+----------------+
| Field          | Type                 | Null | Key | Default | Extra          |
+----------------+----------------------+------+-----+---------+----------------+
| job_db_inx     | int(11)              | NO   | PRI | NULL    | auto_increment |
| mod_time       | int(10) unsigned     | NO   |     | 0       |                |
| deleted        | tinyint(4)           | NO   |     | 0       |                |
| account        | tinytext             | YES  |     | NULL    |                |
| cpus_req       | int(10) unsigned     | NO   |     | NULL    |                |
| cpus_alloc     | int(10) unsigned     | NO   |     | NULL    |                |
| derived_ec     | int(10) unsigned     | NO   |     | 0       |                |
| derived_es     | text                 | YES  |     | NULL    |                |
| exit_code      | int(10) unsigned     | NO   |     | 0       |                |
| job_name       | tinytext             | NO   |     | NULL    |                |
| id_assoc       | int(10) unsigned     | NO   | MUL | NULL    |                |
| id_block       | tinytext             | YES  |     | NULL    |                |
| id_job         | int(10) unsigned     | NO   | MUL | NULL    |                |
| id_qos         | int(10) unsigned     | NO   | MUL | 0       |                |
| id_resv        | int(10) unsigned     | NO   |     | NULL    |                |
| id_wckey       | int(10) unsigned     | NO   | MUL | NULL    |                |
| id_user        | int(10) unsigned     | NO   | MUL | NULL    |                |
| id_group       | int(10) unsigned     | NO   |     | NULL    |                |
| kill_requid    | int(11)              | NO   |     | -1      |                |
| mem_req        | int(10) unsigned     | NO   |     | 0       |                |
| nodelist       | text                 | YES  |     | NULL    |                |
| nodes_alloc    | int(10) unsigned     | NO   |     | NULL    |                |
| node_inx       | text                 | YES  |     | NULL    |                |
| partition      | tinytext             | NO   |     | NULL    |                |
<div id='show_1985066071' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_1985066071'>| priority       | int(10) unsigned     | NO   |     | NULL    |                |
| state          | smallint(5) unsigned | NO   |     | NULL    |                |
| timelimit      | int(10) unsigned     | NO   |     | 0       |                |
| time_submit    | int(10) unsigned     | NO   |     | 0       |                |
| time_eligible  | int(10) unsigned     | NO   | MUL | 0       |                |
| time_start     | int(10) unsigned     | NO   |     | 0       |                |
| time_end       | int(10) unsigned     | NO   |     | 0       |                |
| time_suspended | int(10) unsigned     | NO   |     | 0       |                |
| gres_req       | text                 | NO   |     | NULL    |                |
| gres_alloc     | text                 | NO   |     | NULL    |                |
| gres_used      | text                 | NO   |     | NULL    |                |
| wckey          | tinytext             | NO   |     | NULL    |                |
| track_steps    | tinyint(4)           | NO   |     | NULL    |                |
+----------------+----------------------+------+-----+---------+----------------+

- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf
</div><script type='text/javascript'>
        $('#show_1985066071').click(function() {
            $('#detail_1985066071').slideDown("normal");
            $('#show_1985066071').hide();
            $('#hide_1985066071').show();
        });
        $('#hide_1985066071').click(function() {
            $('#detail_1985066071').slideUp();
            $('#hide_1985066071').hide();
            $('#show_1985066071').show();
        });
        </script></pre></div><div class='update_description'><i onclick="document.location='24516#1428014640'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-02T22:44:00+00:00">Apr 2, 2015 10:44 PM UTC</time> by <b>Carl Edquist</b><a class="anchor" name="1428014640">&nbsp;</a></div><pre>If that is the case that there are some jobs with

time_start + time_suspended &#62; time_end

(which I guess might happen by a small margin depending on where the times come from), then probably we can fix it in the probe by changing

SUM(j.time_end - j.time_start - j.time_suspended) AS wall_time

to something like

SUM(CASE WHEN j.time_start + j.time_suspended &#62; j.time_end THEN 0 ELSE j.time_end - j.time_start - j.time_suspended END CASE) AS wall_time

... but in any case let us know what you see..!

Thanks,
Carl</pre></div><div class='update_description'><i onclick="document.location='24516#1428013854'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-02T22:30:54+00:00">Apr 2, 2015 10:30 PM UTC</time> by <b>Carl Edquist</b><a class="anchor" name="1428013854">&nbsp;</a></div><pre><font color='#7F7E6F'>&#62; Is there a way to enable debugging for the probe that&#39;s run via cron?  Would it be better to change values</font>
<font color='#7F7E6F'>&#62; in /etc/gratia/slurm/ProbeConfig or add &#34;-v&#34; to the command in /etc/cron.d/gratia-probe-slurm.cron?</font>

I&#39;m not familiar with the debugging options for the slurm probe, but definitely anything that you can get to work on the command line you should be able to do in cron also..!

So as you guys may have figured out, the overflow seems to be happening here&#58;

SUM(j.time_end - j.time_start - j.time_suspended) AS wall_time

(from line 309 of SlurmProbe.py, pasting the full query below)

So it might be something with negatives or, conceivably I guess it could just be that the sum is just really large and overflows the BIGINT UNSIGNED type. ...  but apparently that&#39;s 2^64-1, which seems awfully big to overflow even with a lot of values summed...

In any case, I would expect this to error out every time&#58;

SELECT SUM(time_end - time_start - time_suspended) FROM brazos_job_table GROUP BY id_job;

I don&#39;t actually have a slurm instance or database to play with -- does one of you know what the datatypes are for those fields?  (describe brazos_job_table)

... Looks like in mysql 5.5 they changed the behavior to error out on overflow&#58; <a href='http&#58;//dev.mysql.com/doc/refman/5.5/en/out-of-range-and-overflow.html' target='_blank' rel='nofollow'>http&#58;//dev.mysql.com/doc/refman/5.5/en/out-of-range-and-overflow.html</a>

But anyway my hunch is none of the individual values have to be negative; it could be that just evaluating a single (time_end - time_start - time_suspended) as an unsigned value will error out if it goes negative.

I would try something like this&#58;

SELECT id_job, time_end, time_start, time_suspended FROM brazos_job_table WHERE time_end &#60; time_start + time_suspended;

If it returns anything, those rows would cause the error...

Carl

----------

Here&#39;s the original query from SlurmProbe.py&#58;

<div id='show_1160827467' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_1160827467'><font color='#7F7E6F'>&#62;        sql = &#39;&#39;&#39;SELECT j.id_job</font>
<font color='#7F7E6F'>&#62;            , j.exit_code</font>
<font color='#7F7E6F'>&#62;            , j.id_group</font>
<font color='#7F7E6F'>&#62;            , j.id_user</font>
<font color='#7F7E6F'>&#62;            , j.job_name</font>
<font color='#7F7E6F'>&#62;            , j.cpus_alloc</font>
<font color='#7F7E6F'>&#62;            , j.partition</font>
<font color='#7F7E6F'>&#62;            , j.state</font>
<font color='#7F7E6F'>&#62;            , MIN(j.time_start) AS time_start</font>
<font color='#7F7E6F'>&#62;            , MAX(j.time_end) AS time_end</font>
<font color='#7F7E6F'>&#62;            , SUM(j.time_suspended) AS time_suspended</font>
<font color='#7F7E6F'>&#62;            , SUM(j.time_end - j.time_start - j.time_suspended) AS wall_time</font>
<font color='#7F7E6F'>&#62;            , a.acct</font>
<font color='#7F7E6F'>&#62;            , a.user</font>
<font color='#7F7E6F'>&#62;            , ( SELECT MAX(s.max_rss)</font>
<font color='#7F7E6F'>&#62;                FROM %(cluster)s_step_table s</font>
<font color='#7F7E6F'>&#62;                WHERE s.job_db_inx = j.job_db_inx</font>
<font color='#7F7E6F'>&#62;                /* Note&#58; Will underreport mem for jobs with simultaneous steps */</font>
<font color='#7F7E6F'>&#62;              ) AS max_rss</font>
<font color='#7F7E6F'>&#62;            , ( SELECT SUM(s.user_sec) + SUM(s.user_usec/1000000)</font>
<font color='#7F7E6F'>&#62;                FROM %(cluster)s_step_table s</font>
<font color='#7F7E6F'>&#62;                WHERE s.job_db_inx = j.job_db_inx</font>
<font color='#7F7E6F'>&#62;              ) AS cpu_user</font>
<font color='#7F7E6F'>&#62;            , ( SELECT SUM(s.sys_sec) + SUM(s.sys_usec/1000000)</font>
<font color='#7F7E6F'>&#62;                FROM %(cluster)s_step_table s</font>
<font color='#7F7E6F'>&#62;                WHERE s.job_db_inx = j.job_db_inx</font>
<font color='#7F7E6F'>&#62;              ) AS cpu_sys</font>
<font color='#7F7E6F'>&#62;            FROM %(cluster)s_job_table as j</font>
<font color='#7F7E6F'>&#62;            LEFT JOIN %(cluster)s_assoc_table AS a ON j.id_assoc = a.id_assoc</font>
<font color='#7F7E6F'>&#62;            WHERE %(where)s</font>
<font color='#7F7E6F'>&#62;            GROUP BY id_job</font>
<font color='#7F7E6F'>&#62;            HAVING %(having)s</font>
<font color='#7F7E6F'>&#62;            ORDER BY j.time_end</font>
<font color='#7F7E6F'>&#62;        &#39;&#39;&#39; % { &#39;cluster&#39;&#58; self._cluster, &#39;where&#39;&#58; where, &#39;having&#39;&#58; having }</font>
</div><script type='text/javascript'>
        $('#show_1160827467').click(function() {
            $('#detail_1160827467').slideDown("normal");
            $('#show_1160827467').hide();
            $('#hide_1160827467').show();
        });
        $('#hide_1160827467').click(function() {
            $('#detail_1160827467').slideUp();
            $('#hide_1160827467').hide();
            $('#show_1160827467').show();
        });
        </script></pre></div><div class='update_description'><i onclick="document.location='24516#1428006452'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-02T20:27:32+00:00">Apr 2, 2015 08:27 PM UTC</time><a class="anchor" name="1428006452">&nbsp;</a></div><pre>I ran that query and it returns nothing.

I&#39;ve set DebugLevel=&#34;5&#34; in the ProbeConfig for slurm, and will attach the resulting email it sends when run from cron.

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1428005330'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-02T20:08:50+00:00">Apr 2, 2015 08:08 PM UTC</time> by <b>Suchandra Thapa</b><a class="anchor" name="1428005330">&nbsp;</a></div><pre>Okay, could you try running

SELECT time_end - time_start - time_suspended FROM brazos_job_table WHERE time_start &#60; 0  ?

I&#39;m not sure how else there&#39;s an overflow when running the query.

Carl, do you have any ideas about why the error might be occurring?

Suchandra</pre></div><div class='update_description'><i onclick="document.location='24516#1428004517'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-02T19:55:17+00:00">Apr 2, 2015 07:55 PM UTC</time><a class="anchor" name="1428004517">&nbsp;</a></div><pre>The SQL command &#39;SELECT time_suspended FROM brazos_job_table WHERE time_suspended &#60; 0&#39; returns nothing.

Is there a way to enable debugging for the probe that&#39;s run via cron?  Would it be better to change values in /etc/gratia/slurm/ProbeConfig or add &#34;-v&#34; to the command in /etc/cron.d/gratia-probe-slurm.cron?

- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1427910091'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-01T17:41:31+00:00">Apr 1, 2015 05:41 PM UTC</time> by <b>Suchandra Thapa</b><a class="anchor" name="1427910091">&nbsp;</a></div><pre>Could you try running the same query but using time_suspended  instead of time_start?  I&#39;d just like to verify that there&#39;s no negative numbers that&#39;s causing the overflow.   Honestly, I&#39;m a bit stumped here since the SQL seems to be valid when run by hand but invalid when run in the script. I&#39;ll ask the gratia probe developers about this.

Suchandra</pre></div><div class='update_description'><i onclick="document.location='24516#1427847185'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-04-01T00:13:05+00:00">Apr 1, 2015 12:13 AM UTC</time><a class="anchor" name="1427847185">&nbsp;</a></div><pre>I ran the command without &#39;INTO OUTFILE&#39; portion just to see what would be printed and nothing was returned&#58;

# mysql slurmdbd -e &#39;SELECT time_start FROM brazos_job_table WHERE time_start &#60; 0&#39;
#

I reconstructed the SQL query used by /usr/share/gratia/slurm/SlurmProbe.py _jobs function and it ran without issue when using the checkpoint value from /var/lib/gratia/tmp/checkpoint.  The only time the gratia probe seems to fail is when run via cron as the root mailbox on the CE is filled with error messages (all identical to my initial message in this ticket).

If I run &#39;/usr/share/gratia/slurm/slurm_meter --checkpoint -v&#39; by hand I receive no errors and the following is at the end of the lengthy output&#58;

2015-03-31 19&#58;08&#58;35 CDT Gratia&#58; End of execution summary&#58; new records sent successfully&#58; 1
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           new records suppressed&#58; 23
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           new records failed&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           records reprocessed successfully&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           reprocessed records failed&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           handshake records sent successfully&#58; 1
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           handshake records failed&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           bundle of records sent successfully&#58; 1
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           bundle of records failed&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           outstanding records&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           outstanding staged records&#58; 0
2015-03-31 19&#58;08&#58;35 CDT Gratia&#58;                           outstanding records tar files&#58; 0

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1427833457'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-03-31T20:24:17+00:00">Mar 31, 2015 08:24 PM UTC</time> by <b>Suchandra Thapa</b><a class="anchor" name="1427833457">&nbsp;</a></div><pre>Hi,

Can you run the following in the mysql db that slurm is using&#58;

SELECT time_start FROM {cluster}s_job_table
WHERE time_start &#60; 0
INTO OUTFILE &#39;/tmp/orders.txt&#39;

Note, you&#39;ll need to replace {cluster} with the name of your cluster.

You should be able to get the configuration options to access the mysql db in the  slurmdbd.conf file.

When that&#39;s done, could you upload the file?

Thanks,
Suchandra</pre></div><div class='update_description'><i onclick="document.location='24516#1426863349'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-03-20T14:55:49+00:00">Mar 20, 2015 02:55 PM UTC</time> by <b>Suchandra Thapa</b><a class="anchor" name="1426863349">&nbsp;</a></div><pre>Okay, let me get together a set of commands that should determine where the issue is and then get back to you.

Suchandra</pre></div><div class='update_description'><i onclick="document.location='24516#1426789781'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-03-19T18:29:41+00:00">Mar 19, 2015 06:29 PM UTC</time><a class="anchor" name="1426789781">&nbsp;</a></div><pre>Yes, I can run some debugging commands.

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='24516#1426786237'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-03-19T17:30:37+00:00">Mar 19, 2015 05:30 PM UTC</time> by <b>Suchandra Thapa</b><a class="anchor" name="1426786237">&nbsp;</a></div><pre>Hmm, the problem appears to be in the mysql database and with slurm.  Do you have access the to the mysql database that slurm is using in order to run some debugging commands?

Suchandra Thapa
OSG Software Team</pre></div><div class='update_description'><i onclick="document.location='24516#1426628597'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-03-17T21:43:17+00:00">Mar 17, 2015 09:43 PM UTC</time> by <b>Tim Theisen</b><a class="anchor" name="1426628597">&nbsp;</a></div><pre>Let&#39;s start with Suchandra who has knowlege of SLURM. Carl can help him out of this is more of a gratia problem.

...Tim</pre></div><div class='update_description'><i onclick="document.location='24516#1426605221'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-03-17T15:13:41+00:00">Mar 17, 2015 03:13 PM UTC</time> by <b>OSG-GOC</b><a class="anchor" name="1426605221">&nbsp;</a></div><pre>After updating my CE to OSG 3.2.21 I noticed my site no longer is reporting Gratia data.  I&#39;ve had to enable email notification of cron to get the actual error as I can&#39;t reproduce it when I run the command by hand.

Command reported&#58;

/usr/share/gratia/common/cron_check /etc/gratia/slurm/ProbeConfig && /usr/share/gratia/slurm/slurm_meter -s 900 -c

Error&#58;

Traceback (most recent call last)&#58;
File &#34;/usr/share/gratia/slurm/slurm_meter&#34;, line 234, in &#60;module&#62;
SlurmMeter().main()
File &#34;/usr/share/gratia/slurm/slurm_meter&#34;, line 217, in main
for job in self.sacct.completed_jobs(self.checkpoint.val)&#58;
File &#34;/usr/share/gratia/slurm/SlurmProbe.py&#34;, line 334, in _jobs
cursor.execute(sql)
File &#34;/usr/lib64/python2.6/site-packages/MySQLdb/cursors.py&#34;, line 173, in execute
self.errorhandler(self, exc, value)
File &#34;/usr/lib64/python2.6/site-packages/MySQLdb/connections.py&#34;, line 36, in defaulterrorhandler
raise errorclass, errorvalue
_mysql_exceptions.OperationalError&#58; (1690, &#34;BIGINT UNSIGNED value is out of range in &#39;(&#96;slurmdbd&#96;.&#96;j&#96;.&#96;time_end&#96; - &#96;slurmdbd&#96;.&#96;j&#96;.&#96;time_start&#96;)&#39;&#34;)

When I execute the command with &#34;-s 900&#34; removed I get no error.  It seems about once every 20 minutes I&#39;m getting an email from cron with the above error.

Below is the gratia slurm ProbeConfig

# cat /etc/gratia/slurm/ProbeConfig
&#60;ProbeConfiguration

Title1=&#34;Collector Information&#34;

CollectorHost=&#34;gratia-osg-prod.opensciencegrid.org&#58;80&#34;
SSLHost=&#34;gratia-osg-prod.opensciencegrid.org&#58;80&#34;
SSLRegistrationHost=&#34;gratia-osg-prod.opensciencegrid.org&#58;80&#34;

CollectorService=&#34;/gratia-servlets/rmi&#34;
<div id='show_1055959727' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_1055959727'>SSLCollectorService=&#34;/gratia-servlets/rmi&#34;
RegistrationService=&#34;/gratia-registration/register&#34;

Title2=&#34;Probe information and functional configuration&#34;

ProbeName=&#34;slurm&#58;ce01.brazos.tamu.edu&#34;
SiteName=&#34;TAMU_BRAZOS_CE&#34;
Grid=&#34;OSG&#34;
SuppressUnknownVORecords=&#34;0&#34;
SuppressNoDNRecords=&#34;0&#34;
SuppressGridLocalRecords=&#34;1&#34;
QuarantineUnknownVORecords=&#34;1&#34;
EnableProbe=&#34;1&#34;

Title3=&#34;Tuning parameter&#34;

BundleSize=&#34;100&#34;
MaxPendingFiles=&#34;100000&#34;
MaxStagedArchives=&#34;400&#34;
UseSyslog=&#34;0&#34;
ConnectionTimeout=&#34;900&#34;

LogLevel=&#34;2&#34;
Comments32=&#34;Controls debug messages printed to log file.&#34;
DebugLevel=&#34;0&#34;
Comments33=&#34;Controls debug messages printed to screen.&#34;
LogRotate=&#34;31&#34;
DataFileExpiration=&#34;31&#34;
Comments34=&#34;The number of days quarantined and unusable data files are kept&#34;
QuarantineSize=&#34;200&#34;
Comments35=&#34;The maximum size in Mb allowed to be kept in each quarantined directory&#34;
GratiaExtension=&#34;gratia.xml&#34;

Title4=&#34;Authentication Configuration&#34;

UseSSL=&#34;0&#34;
CertificateFile=&#34;/etc/grid-security/hostcert.pem&#34;
KeyFile=&#34;/etc/grid-security/hostkey.pem&#34;
UseGratiaCertificates=&#34;0&#34;
Comments40=&#34;If no directory is specified the gratia certificate file will be created in &#39;WorkingFolder&#39;/certs.&#34;
GratiaCertificateFile=&#34;/var/lib/gratia/data/certs/gratia.probecert.pem&#34;
GratiaKeyFile=&#34;/var/lib/gratia/data/certs/gratia.probekey.pem&#34;

Title5=&#34;File and directory location&#34;

UserVOMapFile=&#34;/var/lib/osg/user-vo-map&#34;
Comments51=&#34;Location and wildcard pattern of log files that contains certificate information about the jobs in the format followed by the &#39;blah demons&#39;.&#34;
CertInfoLogPattern=&#34;/var/log/accounting/blahp.log-*&#34;
CondorCEHistoryFolder=&#34;/var/lib/gratia/condorce_data&#34;

DataFolder=&#34;/var/lib/gratia/data/&#34;
WorkingFolder=&#34;/var/lib/gratia/tmp&#34;
LogFolder=&#34;/var/log/gratia&#34;

SlurmDbHost=&#34;OMIT.brazos.tamu.edu&#34;
SlurmDbPort=&#34;3306&#34;
SlurmDbUser=&#34;gratia_slurm&#34;
SlurmDbPasswordFile=&#34;/root/.slurmdbd&#34;
SlurmDbName=&#34;slurmdbd&#34;
SlurmCluster=&#34;brazos&#34;

SlurmLocation=&#34;/usr&#34;
/&#62;

&#60;!-- This probe has not yet been configured --&#62;

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf

</div><script type='text/javascript'>
        $('#show_1055959727').click(function() {
            $('#detail_1055959727').slideDown("normal");
            $('#show_1055959727').hide();
            $('#hide_1055959727').show();
        });
        $('#hide_1055959727').click(function() {
            $('#detail_1055959727').slideUp();
            $('#hide_1055959727').hide();
            $('#show_1055959727').show();
        });
        </script></pre></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F24516">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

    //enable autocomplete for search box
    $("#search").autocomplete({
        source: function( request, response ) {
            $.ajax({
                url: "search/autocomplete",
                dataType: "text",
                data: {
                    //featureClass: "P",
                    //style: "full",
                    //maxRows: 12,
                    //name_startsWith: request.term
                    q: request.term
                },
                success: function( data ) {
                    response( $.map( data.split("\n"), function( item ) {
                        if(item == "") return null;
                        return {
                            value: item
                        }
                    }));
                }
            });
        },
        select: function(event, ui) {
            document.location = "search?q="+ui.item.value;
        }
    });
    
});
</script>


</body>
