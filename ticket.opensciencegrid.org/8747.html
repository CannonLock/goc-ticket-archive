<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[8747] OSG Storage&#58; Bestman&#58; Increasing log file size</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <link href="https://ticket.opensciencegrid.org/rss" rel="alternate" type="application/rss+xml" title="GOC Ticket Update feed" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=8747" method="post">
<div class="page-header">
    <h3><span class="muted">8747</span> / OSG Storage&#58; Bestman&#58; Increasing log file size</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">terrence martin</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls"></div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2010-06-16</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Neha Sharma <span class="muted"> / OSG Storage Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/8747", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src=\""+this.thumbnail_url+"\"/></td>";
            html += "<td><a href=\""+this.url+"\" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='8747#1276718160'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2010-06-16T19:56:00+00:00">Jun 16, 2010 07:56 PM UTC</time> by <b>Neha Sharma</b><a class="anchor" name="1276718160">&nbsp;</a></div><pre>terrence

can I go ahead and close this? looks like more of a discussion at this point
thanks
-neha

On Tuesday 15 June 2010 11&#58;49&#58;01 pm Junmin wrote&#58;
Terrance.

a) put &#34;silent=true&#34; in your rc file, most of the std outputs will be
hidden.

Most? What does that trim out?

b) I understand the description of the problem. So, what sound like a
reasonable behavior from the server when rotation fails
(for whatever reason)? What I can think of is among&#58;these&#58; grow the
event log file, or reuse the file (as it is now), or stop logging
completely, or exit the program..
any other suggestions?

Definitely do not exit at rotation time, this is not a critical error, using
the same log file would be fine as long as it logged that it could not create
the first rotation. Bestman could also check the permissions of the log
directory on startup and fail with a notification.

c) Since you tried with a different directory, and all went well, it
demonstrated the log rotation failed. However,
if bestman has no permission in the original directory, how can
event.srm.log be allowed to be created and written
by bestman (at started up time)? this is the part the confused me.
If bestman has no permission to write log to a directory,
it would not start up.  In your case, it started up successfully, so
the only possible explanation is the directory permission got
changed in the middle, which is rather odd.  Do you agree?
<div id='show_565107943' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_565107943'>
Nope, this is how it worked

touch event.srm.log
chown daemon&#58;daemon event.srm.log

Startup did not require a directory permission to be correct, just that it can
write to the event log itself. In hindsight it should have been obvious to me
the rotation would fail, though I did not originally know that Bestman even
rotated log files. &#58;) Adding a directory check on startup would probably solve
the issue.

Terrence

- Junmin

On 6/15/2010 10&#58;59 AM, Terrence Martin wrote&#58;
On Monday 14 June 2010 02&#58;13&#58;22 pm Junmin wrote&#58;
So what is the problem? I would like understand.
From what you described last week, bestman is able to create the
event.srm.log in the assigned directory.
How come it is not allowed to do rotation?

I explained this already in a previous email.

- Bestman event log file hits 50MB, or whatever your internal trigger
(that cannot be configured) is.
- Bestman uses whatever method internally to attempt to rotate the log
- Bestman fails to rotate the log properly due to permission problems and
fails silently, or puts an error somewhere that is perhaps erased
immediately - Having failed silently bestman truncates the existing event
log to 0 and starts writing again.

That is what is going on in the event log based on my observations. Once
I placed the bestman logs in a directory that the bestman process could
write to rotation is occurring normally.

[1050] root@bsrm-1 /var/log/bestman# ls -l
total 629608
-rw-r--r-- 1 daemon daemon  44322231 Jun 15 10&#58;50 bestman_stderr.log
-rw-r--r-- 1 daemon daemon 127332480 Jun 15 10&#58;50 bestman_stdout.log
-rw-r--r-- 1 daemon daemon  18922375 Jun 15 10&#58;50 event.srm.log
-rw-r--r-- 1 daemon daemon  45359391 Jun 11 22&#58;04 event.srm.log.1
-rw-r--r-- 1 daemon daemon  45414632 Jun 15 08&#58;54 event.srm.log.10
-rw-r--r-- 1 daemon daemon  45344501 Jun 12 06&#58;02 event.srm.log.2
-rw-r--r-- 1 daemon daemon  45305283 Jun 12 10&#58;16 event.srm.log.3
-rw-r--r-- 1 daemon daemon  45327312 Jun 12 16&#58;00 event.srm.log.4
-rw-r--r-- 1 daemon daemon  45349809 Jun 13 06&#58;45 event.srm.log.5
-rw-r--r-- 1 daemon daemon  45291156 Jun 14 05&#58;15 event.srm.log.6
-rw-r--r-- 1 daemon daemon  45336582 Jun 14 12&#58;34 event.srm.log.7
-rw-r--r-- 1 daemon daemon  45338098 Jun 14 17&#58;04 event.srm.log.8
-rw-r--r-- 1 daemon daemon  45352383 Jun 14 23&#58;44 event.srm.log.9
[1050] root@bsrm-1 /var/log/bestman#

I repeat the problem was one of permission though Bestman might handle
the situation better.

As for the STDOUT and STDERR, I realize that Java container based systems
are typically much more lax on consistent logging than other OS based
servers. Nonetheless it is irritating to me that bestman is dumping
literally hundreds of MB of logs to files that are not getting rotated
properly, and were they rotated by an external program, would likely
cause all sorts of file handle issues.

Bestman puts far too much logging out on STDOUT and STDERR that should be
properly caught and handled through its logging rotation system, and not
spewed on STDERR and STDOUT. How do you even control the STDOUT and
STDERR vebosity level? I see how to control it for the event log, but
STDOUT and STDERR are just redirects from the bestman.server script.

Terrence

most screen outputs are in the log.
I added a few print outs in the update you have. they are not in
eventlog as we are supposed to debug about it.

- Junmin

On 6/14/2010 2&#58;03 PM, Terrence Martin wrote&#58;
Rotation seems to work fine and it was, as I had suspected a permission
problem.  I do notice that stdout and stderr, which produce a lot of
output, do not get rotated. How come bestman dumps so much to std out
and error and does not grab that information and sent it to a log file?

Terrence

On Friday 11 June 2010 04&#58;01&#58;27 pm Junmin wrote&#58;
In this case, do you mind if I give you a test library to try??

- Junmin

On 6/11/2010 3&#58;19 PM, Terrence Martin wrote&#58;
Ok this is what is likely happening assuming log file rotates at 50MB

- Log file hits 50MB
- Bestman triggers its log rotation code
- Bestman attempts and fails to create the log.N
- Logfile is truncated and starts back at 0

The reason the log file I show is not 50MB is because if it was it
would have triggered the sequence of events above and been truncated
back to zero. In other words the moment it hits 50MB it goes back to
0 therefore we would never see it at 50, and since the rotation file
never gets created, likely due to permission problems, we never see
that either.

Trust me, our Bestman hits 50MB about every 6 hours based on the time
stamp of the first line in the current event log and its now 42MB
size. For an active CMS T2 like ours that heavily uses Bestman SRM
50MB is a trivial amount for the log file triggering 4 rotations a
day. If it were possible I would increase the size considerably.

Terrence

On Friday 11 June 2010 02&#58;18&#58;33 pm Junmin wrote&#58;
Rotation occurs when log size reaches 50MB.

So far I do not know what Terrence is planning to resolve.

- Junmin

On 6/11/2010 2&#58;15 PM, Horst Severini wrote&#58;
Hi Terrence,

So the problem is the rotations are not working

[1407] root@bsrm-1 /var/log# l *event.srm* *bestman*
-rw-r--r-- 1 daemon daemon  2143112 Jun 11 14&#58;07
bestman_stderr.log -rw-r--r-- 1 daemon daemon  8504347 Jun 11
14&#58;07 bestman_stdout.log -rw-r--r-- 1 daemon daemon 32638242 Jun
11 14&#58;07 event.srm.log [1407] root@bsrm-1 /var/log#

Could it be a permission problem? That is when the rotations occur
they fail to be created and then it just has the old event logs?

I think that&#39;s a pretty good assumption, that the bestman user
can&#39;t create new files in /var/log/.

Perhaps a better directory might be /var/log/bestman ? owned by
the bestman user?

Either that, or leave them in the bestman pacman tree, and just
make a soft link from /var/log/ to them. I would personally prefer
that, since I really like to confine all VDT package content to the
respective VDT tree.

This was not my setting actually, though I would prefer
/var/log/bestman. I myself do not like how VDT manages logs at all
shoving them all over the place in its tree.

Terrence
</div><script type='text/javascript'>
        $('#show_565107943').click(function() {
            $('#detail_565107943').slideDown("normal");
            $('#show_565107943').hide();
            $('#hide_565107943').show();
        });
        $('#hide_565107943').click(function() {
            $('#detail_565107943').slideUp();
            $('#hide_565107943').hide();
            $('#show_565107943').show();
        });
        </script></pre></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F8747">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

    //enable autocomplete for search box
    $("#search").autocomplete({
        source: function( request, response ) {
            $.ajax({
                url: "search/autocomplete",
                dataType: "text",
                data: {
                    //featureClass: "P",
                    //style: "full",
                    //maxRows: 12,
                    //name_startsWith: request.term
                    q: request.term
                },
                success: function( data ) {
                    response( $.map( data.split("\n"), function( item ) {
                        if(item == "") return null;
                        return {
                            value: item
                        }
                    }));
                }
            });
        },
        select: function(event, ui) {
            document.location = "search?q="+ui.item.value;
        }
    });
    
});
</script>


</body>
