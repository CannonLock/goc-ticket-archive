<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[32929] osg oportunistic dead jobs keep running (Singularity)</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <link href="https://ticket.opensciencegrid.org/rss" rel="alternate" type="application/rss+xml" title="GOC Ticket Update feed" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
    <script src='https://www.google.com/recaptcha/api.js'></script>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=32929" method="post">
<div class="page-header">
    <h3><span class="muted">32929</span> / osg oportunistic dead jobs keep running (Singularity)</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">Juan Eduardo Ramirez Vargas</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    <div class="control-group"><label class="control-label">Submitted Via</label><div class="controls">GOC Ticket/submit</div></div><div class="control-group"><label class="control-label">Submitter</label><div class="controls">Juan Eduardo Ramirez Vargas</div></div><div class="control-group"><label class="control-label">Ticket Links</label><div class="controls"></div></div>
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls">Waiting for user action</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2017-03-27</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Kyle Gross <span class="muted"> / OSG GOC Support Team</span></div><div class="assignee" style="width: 60%">Software Support (Triage) <span class="muted"> / OSG Software Team</span></div><div class="assignee" style="width: 60%">Derek Weitzel <span class="muted"> / OSG Software Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/32929", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src="\&quot;&quot;+this.thumbnail_url+&quot;\&quot;/"></td>";
            html += "<td><a href="\&quot;&quot;+this.url+&quot;\&quot;" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
        <div class="btn-group">
                <a class="btn btn-small" href="https://ticket.opensciencegrid.org/32929?sort=up&amp;"><i class="icon-arrow-up"></i> Sort</a>

        
        <a class="btn btn-small" href="https://ticket.opensciencegrid.org/32929?expandall=true&amp;">Expand Descriptions</a>        <a class="btn btn-small" target="_blank" href="mailto:osg@tick.globalnoc.iu.edu?subject=Open%20Science%20Grid%3A%20osg%20oportunistic%20dead%20jobs%20keep%20running%20%28Singularity%29%20ISSUE%3D32929%20PROJ%3D71"><i class="icon-envelope"></i> Update w/Email</a>
        </div>
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='32929#1490877353'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-30T12:35:53+00:00">Mar 30, 2017 12:35 PM UTC</time> by <b>Kyle Gross</b><a class="anchor" name="1490877353">&nbsp;</a></div><pre>Closing this ticket per Eduardo&#39;s update.</pre></div><div class='update_description'><i onclick="document.location='32929#1490272153'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-23T12:29:13+00:00">Mar 23, 2017 12:29 PM UTC</time> by <b>juaneduardo.ramirez@....</b><a class="anchor" name="1490272153">&nbsp;</a></div><pre>Thanks Mats,
Incidentally last week, my hostcert for my gums server expired and
had air condition problems in the lab. Both caused the cluster to be
offline. I used the opportunity for hunting root.exe processes in the
nodes and kill it. I did not see new ones coming this week. Sorry for
not reporting before about this.

If you want you can close this ticket. If problem reappear I can open a
new ticket (hopefully not).
Eduardo

On 03/22/2017 09&#58;12 PM, Open Science Grid FootPrints wrote&#58;
<font color='#7F7E6F'>&#62; [Duplicate message snipped]</font></pre></div><div class='update_description'><i onclick="document.location='32929#1489512633'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-14T17:30:33+00:00">Mar 14, 2017 05:30 PM UTC</time><a class="anchor" name="1489512633">&nbsp;</a></div><pre>Eduardo,

I&#39;m sorry that you are experiencing issues with the OSG VO glideins. From your pstree we have determined that the root.exe call was from an old test in our advertising script, and we have now disabled that test. Feel free to kill all osg jobs/processes on your machine, and hopefully the new ones will behave better.

This doesn&#39;t fully explain the missing directory, but at least you should not see any root.exe processes anymore.

/Mats

by /DC=org/DC=opensciencegrid/O=Open Science Grid/OU=People/CN=Mats Rynge 45</pre></div><div class='update_description'><i onclick="document.location='32929#1489503208'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-14T14:53:28+00:00">Mar 14, 2017 02:53 PM UTC</time> by <b>Tim Theisen</b><a class="anchor" name="1489503208">&nbsp;</a></div><pre>Assigning to Derek</pre></div><div class='update_description'><i onclick="document.location='32929#1489443303'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-13T22:15:03+00:00">Mar 13, 2017 10:15 PM UTC</time><a class="anchor" name="1489443303">&nbsp;</a></div><pre>Hi again,
even today those (broken) jobs are arriving to my site.(T3_US_PuertoRico)
For example the directory  /var/lib/condor/execute/dir_1278371/glide_3X5g3h does not exist any more, but
ps faux output is shown below.
This is causing on wn the cpu is oversuscribed.
I am manually killing the executable, but need advise why is this happening.
Or how to stop happen again for new coming grid jobs instead of hunting extra executables (with help of ganglia).

Up to now only I see this from opportunistic osg jobs, not from cms jobs.

Thanks
Eduardo

ps faux
...
osg      1358748  0.0  0.0  11344  1364 ?        S    Mar12   0&#58;00 /bin/bash /var/lib/condor/execute/dir_1278371/glide_3X5g3h/client/osgvo-node-advertise /var/lib/condor/execute/dir_1278371/glide_3X5g3h/glidein_config client
osg      1359135  0.0  0.0   4148   628 ?        S    Mar12   0&#58;00  &#92;_ /usr/libexec/singularity/sexec /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      1359157  0.0  0.0   4148   336 ?        S    Mar12   0&#58;00      &#92;_ /usr/libexec/singularity/sexec /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      1359160  0.0  0.0  11312   268 ?        S    Mar12   0&#58;00          &#92;_ /bin/bash /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      1361221  0.0  0.0  11312   288 ?        S    Mar12   0&#58;00              &#92;_ /bin/bash /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      1361243 45.9  0.0  20136  3280 ?        R    Mar12 553&#58;57                  &#92;_ root.exe -l -b -q
osg      2977981  0.0  0.0  11344  1364 ?        S    06&#58;44   0&#58;00 /bin/bash /var/lib/condor/execute/dir_1983749/glide_G61lRQ/client/osgvo-node-advertise /var/lib/condor/execute/dir_1983749/glide_G61lRQ/glidein_config client
osg      2978217  0.0  0.0   4148   628 ?        S    06&#58;44   0&#58;00  &#92;_ /usr/libexec/singularity/sexec /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      2978222  0.0  0.0   4148   336 ?        S    06&#58;44   0&#58;00      &#92;_ /usr/libexec/singularity/sexec /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      2978224  0.0  0.0  11312   268 ?        S    06&#58;44   0&#58;00          &#92;_ /bin/bash /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      2979655  0.0  0.0  11312   288 ?        S    06&#58;44   0&#58;00              &#92;_ /bin/bash /srv/client/osgvo-node-advertise /srv/glidein_config client
osg      2979677 35.6  0.0  20136  3276 ?        R    06&#58;44 223&#58;00                  &#92;_ root.exe -l -b -q

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jramirez/CN=662428/CN=Juan Eduardo Ramirez Vargas</pre></div><div class='update_description'><i onclick="document.location='32929#1489154819'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-10T14:06:59+00:00">Mar 10, 2017 02:06 PM UTC</time><a class="anchor" name="1489154819">&nbsp;</a></div><pre>Hi again,
My guessing is that when higher priority grid jobs arrive (cms) the opportunistic osg job is killed (or suspended?).
However, only the pilot is killed but the job inside the pilot keep running. (yet the original directory does not exist any more.)

I do not know if this is a side effect of my site configuration conflicting with singularity.
Because I have set in my CE
worker_node_temp = /tmp (/etc/osg/config.d/10-storage.ini) and
in my WNs I redefine in a condor job wrapper
export OSG_WN_TMP=$_CONDOR_SCRATCH_DIR

I mention this because, I am noticing on the WN /tmp dir, directories of the type&#58;
/tmp/glide_osg_xxxxxx
/tmp/.singularity-session-5458.34.514
instead of the being inside the $_CONDOR_SCRATCH_DIR

It is possible, that this config tweak could cause what I am seeing on my site?
Could someone comment?

Thanks,
Eduardo

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jramirez/CN=662428/CN=Juan Eduardo Ramirez Vargas</pre></div><div class='update_description'><i onclick="document.location='32929#1488913125'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-03-07T18:58:45+00:00">Mar 7, 2017 06:58 PM UTC</time> by <b>OSG-GOC</b><a class="anchor" name="1488913125">&nbsp;</a></div><pre>Hi
I just noticed, some possible dead osg jobs are still using cpu. But not showing in condor.
Below is a top output showing the osg.
Also de condor_who showing only cms is running.

I just installed Singularity few days ago. Our WN is SL6 my CE is cms-grid0.hep.uprm.edu

Eduardo

[root@sandy-1-2 ~]# top

top - 14&#58;49&#58;46 up 5 days, 23&#58;05,  1 user,  load average&#58; 8.83, 9.00, 8.92
Tasks&#58; 307 total,   8 running, 299 sleeping,   0 stopped,   0 zombie
Cpu(s)&#58; 82.9%us, 16.8%sy,  0.0%ni,  0.0%id,  0.0%wa,  0.0%hi,  0.3%si,  0.0%st
Mem&#58;  24577076k total, 22330792k used,  2246284k free,  3364896k buffers
Swap&#58;  4194300k total,   214528k used,  3979772k free, 11756356k cached

PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
1894608 uscms099  20   0 7187m 3.1g 164m R 316.4 13.3 414&#58;41.23 cmsRun
1897761 uscms163  20   0 1155m 812m 112m R 99.7  3.4  80&#58;41.15 cmsRun
2669385 osg       20   0 20136 3280  208 R 99.7  0.0   1452&#58;14 root.exe
3890132 osg       20   0 23980 6004  208 R 99.4  0.0   1229&#58;36 root.exe
1904996 uscms311  20   0 1078m 814m 122m R 94.7  3.4  27&#58;37.25 cmsRun
587219 osg       20   0 23980 7244  208 R 87.4  0.0   4583&#58;30 root.exe

[root@sandy-1-2 ~]# condor_who

OWNER           CLIENT           SLOT JOB        RUNTIME    PID     PROGRAM
uscms3183@local grid-0-0-0.local  1_1 732807.0   0+09&#58;30&#58;57 1805612 /var/lib/condor/execute/dir_1805608/condor_

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jramirez/CN=662428/CN=Juan Eduardo Ramirez Vargas</pre></div><legend>Similar Recent Tickets <small>modified within the last 30 days</small></legend><div id="similar_tickets"><p class="muted">No similar tickets found.</p></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F32929">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script src="https://ticket1.grid.iu.edu:8443/socket.io/socket.io.js"></script>
<script>
var chat = io.connect('https://ticket1.grid.iu.edu:8443');
chat.on('connect', function() {
    chat.emit('authenticate', {nodekey:'', ticketid: 32929});
});
chat.on('peers', function(peers) {
    $("#peers").html("");
    for(var pid in peers) {
        var peer = peers[pid];
        addPeer(pid, peer);
    }
});
chat.on('peer_disconnect', function(pid) {
    $("#peer_"+pid).hide("slow");
});
chat.on('peer_connected', function(peers) {
    //expect only 1 peer connecting, but..
    for(var pid in peers) {
        var peer = peers[pid];
        addPeer(pid, peer);
    }
});
chat.on('submit', function() {
    if(confirm("This ticket was updated. Do you want to refresh?")) {
        history.go(0);
    }
});

function addPeer(pid, peer) {
    var ipinfo = "";
    if(peer.ip != undefined) {
        ipinfo = "<span class=\"ip\">"+peer.ip+"</span>";
    }
    if(chat.io.engine.id == pid) {
        //don't display myself
        return;
    }
    var html = "<li class=\"new\" id=\"peer_"+pid+"\" class=\"peer\">"+peer.name+ipinfo+"</li>";
    $("#peers").prepend(html);
    $("#peers .new").animate({bottom: 0}, 1000, function() {$(this).removeClass("new")});
}

$(function() {
    $("#ticket_form").submit(function() {
        chat.emit('submit');
        return true;
    });
});
</script>
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

    //enable autocomplete for search box
    $("#search").autocomplete({
        source: function( request, response ) {
            $.ajax({
                url: "search/autocomplete",
                dataType: "text",
                data: {
                    //featureClass: "P",
                    //style: "full",
                    //maxRows: 12,
                    //name_startsWith: request.term
                    q: request.term
                },
                success: function( data ) {
                    response( $.map( data.split("\n"), function( item ) {
                        if(item == "") return null;
                        return {
                            value: item
                        }
                    }));
                }
            });
        },
        select: function(event, ui) {
            document.location = "search?q="+ui.item.value;
        }
    });
    
});
</script>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-69012-13");
pageTracker._trackPageview();
} catch(err) {}
</script>

</body>
