<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[34479] repeated squid cache misses for 350MB file</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <link href="https://ticket.opensciencegrid.org/rss" rel="alternate" type="application/rss+xml" title="GOC Ticket Update feed" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=34479" method="post">
<div class="page-header">
    <h3><span class="muted">34479</span> / repeated squid cache misses for 350MB file</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">Richard T. Jones</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    <div class="control-group"><label class="control-label">Submitted Via</label><div class="controls">GOC Ticket/submit</div></div><div class="control-group"><label class="control-label">Submitter</label><div class="controls">Richard T. Jones</div></div><div class="control-group"><label class="control-label">Ticket Links</label><div class="controls"></div></div>
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls">ENG Action</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2017-08-04</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Kyle Gross <span class="muted"> / OSG GOC Support Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/34479", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src=\""+this.thumbnail_url+"\"/></td>";
            html += "<td><a href=\""+this.url+"\" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
        <div class="btn-group">
                <a class="btn btn-small" href="https://ticket.opensciencegrid.org/34479?sort=up&amp;"><i class="icon-arrow-up"></i> Sort</a>

        
        <a class="btn btn-small" href="https://ticket.opensciencegrid.org/34479?expandall=true&amp;">Expand Descriptions</a>        <a class="btn btn-small" target="_blank" href="mailto:osg@tick.globalnoc.iu.edu?subject=Open%20Science%20Grid%3A%20repeated%20squid%20cache%20misses%20for%20350MB%20file%20ISSUE%3D34479%20PROJ%3D71"><i class="icon-envelope"></i> Update w/Email</a>
        </div>
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='34479#1501257551'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-28T15:59:11+00:00">Jul 28, 2017 03:59 PM UTC</time> by <b>GLUEX</b><a class="anchor" name="1501257551">&nbsp;</a></div><pre>This ticket can be closed. The cause for the problem was identified and has
been solved. Thank you.
-Richard Jones

On Thu, Jul 27, 2017 at 12&#58;57 PM, Open Science Grid FootPrints &#60;
osg@....&#62; wrote&#58;

<font color='#7F7E6F'>&#62; [Duplicate message snipped]</font></pre></div><div class='update_description'><i onclick="document.location='34479#1501174629'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-27T16:57:09+00:00">Jul 27, 2017 04:57 PM UTC</time> by <b>Kyle Gross</b><a class="anchor" name="1501174629">&nbsp;</a></div><pre>Is there anything else to do with this ticket at this point?

-Kyle</pre></div><div class='update_description'><i onclick="document.location='34479#1500482397'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-19T16:39:57+00:00">Jul 19, 2017 04:39 PM UTC</time><a class="anchor" name="1500482397">&nbsp;</a></div><pre>Dave, so THAT was it. I never checked to see if the wget was getting a FORWARD response. Bingo, thank you. I will fix this and see if that resolves the problem.
Scott, the direction you suggest is also a good one. After this test, if I find the fetches are still creating congestion issues, I will follow up on that.

-Richard Jones

by /DC=org/DC=opensciencegrid/O=Open Science Grid/OU=People/CN=Richard T. Jones 594</pre></div><div class='update_description'><i onclick="document.location='34479#1500410040'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T20:34:00+00:00">Jul 18, 2017 08:34 PM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1500410040">&nbsp;</a></div><pre>The problem with your URL is that redirects to https.  A web proxy is essentially a man-in-the-middle, which https is designed to defeat, so web proxies cannot work with https.

Yes sorry, I meant 8MB and 32MB, not 8GB and 32GB.  When many worker nodes request the same large file at once, then squid has to try to send it as fast as it can and the data competes with all other traffic being sent in parallel.  By splitting up a large file into smaller chunks, it slows the traffic down a bit and allows other requests to get a chance to get in.  It makes sure the worker node is completely finished processing the first chunk before the next chunk is requested.  Unlike many high speed storage systems, squid does not do any queueing so all requests are handled in parallel and many big requests at once bog it down.   The majority of the squid machines at sites are still 1gbit/second as far as I know.  The recommended bandwidth is 1 gigabit per 1000 job slots.</pre></div><div class='update_description'><i onclick="document.location='34479#1500405765'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T19:22:45+00:00">Jul 18, 2017 07:22 PM UTC</time><a class="anchor" name="1500405765">&nbsp;</a></div><pre>Dave, on the split size, did you mean MB, not GB?
-Richard

by /DC=org/DC=opensciencegrid/O=Open Science Grid/OU=People/CN=Richard T. Jones 594</pre></div><div class='update_description'><i onclick="document.location='34479#1500405703'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T19:21:43+00:00">Jul 18, 2017 07:21 PM UTC</time><a class="anchor" name="1500405703">&nbsp;</a></div><pre>Hello Dave,
The url of the file is <a href='http&#58;//halldweb.jlab.org/dist/ccdb.sqlite' target='_blank' rel='nofollow'>http&#58;//halldweb.jlab.org/dist/ccdb.sqlite</a>
Why would it strain the squids, when it is exactly the same one file that is being downloaded?
The file is only 320MB, I don&#39;t understand the part about splitting? What size splits?
-Richard

by /DC=org/DC=opensciencegrid/O=Open Science Grid/OU=People/CN=Richard T. Jones 594</pre></div><div class='update_description'><i onclick="document.location='34479#1500405521'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T19:18:41+00:00">Jul 18, 2017 07:18 PM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1500405521">&nbsp;</a></div><pre>Hi Richard,

A 350MB file will probably strain squids but they should in general work.  The default limit for caching is 1GB although that would quite severely strain squids when there as many jobs as you&#39;re running.  What&#39;s the URL of your file?  Maybe the server headers aren&#39;t set right.

It would be a bit easier on the squids if you broke up the file into pieces with split -b, and had the clients read each piece separately and put them back together.    CVMFS chunks at 8GB but 32GB should be sufficient.

If you have trouble with reliability of the squid downloads ask me about my wget wrapper.

Dave</pre></div><div class='update_description'><i onclick="document.location='34479#1500404273'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T18:57:53+00:00">Jul 18, 2017 06:57 PM UTC</time> by <b>Scott Teige</b><a class="anchor" name="1500404273">&nbsp;</a></div><pre>My immediate concern with the timing of your runs, the jobs might start running before the db update is available. I suggest attempting to use the $OSG_DATA area and determining if this solves your problem. Dave might have a different idea but a solution is a solution.</pre></div><div class='update_description'><i onclick="document.location='34479#1500403927'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T18:52:07+00:00">Jul 18, 2017 06:52 PM UTC</time> by <b>Scott Teige</b><a class="anchor" name="1500403927">&nbsp;</a></div><pre>Hello,
I&#39;m adding Dave Dykstra to comment on squids and cvmfs.</pre></div><div class='update_description'><i onclick="document.location='34479#1500403926'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T18:52:06+00:00">Jul 18, 2017 06:52 PM UTC</time> by <b>Scott Teige</b><a class="anchor" name="1500403926">&nbsp;</a></div><pre>Hello,
I&#39;m adding Dave Dykstra to comment on squids and cvmfs.</pre></div><div class='update_description'><i onclick="document.location='34479#1500391525'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2017-07-18T15:25:25+00:00">Jul 18, 2017 03:25 PM UTC</time> by <b>OSG-GOC</b><a class="anchor" name="1500391525">&nbsp;</a></div><pre>OSG production planning experts,
We are setting up for a production run, and have encountered a surprise with remote file accesses. Our jobs all need to read from a sqlite database file which is about 350MB in size. This file gets updated every night, so rather than push it to cvmfs, we decided to have the jobs pull a fresh copy from a web server using wget, with http_proxy set to the value of OSG_SQUID_LOCATION. Last night we submitted 2000 jobs, which ran on a dozen or so sites, and to our surprise there were nearly 2000 separate fetches of the same sqlite file from our web server, which knocked it offline for a while. Is 350MB too large for it to be cached on the squid? Is cvmfs a better choice for this? Or should our jobs be managing their own cache of this file on the $OSG_DATA area? Here are the statistics on repeated cache misses for this file that we recorded overnight.
-Richard Jones

its-condor-squid1.syr.edu                                            85
eddie.crc.nd.edu                                                             26
hcc-pki-nat-c3930.unl.edu                                           1
hcc-pki-nat-c3931.unl.edu                                           2
red-squid1.unl.edu                                                         1
red-squid2.unl.edu                                                         5
136.145.164.181                                                                22
gryphn.phys.uconn.edu                                                29
osgsquid01.hep.wisc.edu                                             167
osgsquid02.hep.wisc.edu                                             198
iut2-squid.mwt2.org                                                       21
cvmfs-1.t2.ucsd.edu                                                       1366
cmsprxy01.colorado.edu                                              757
uct2-squid.mwt2.org                                                      133
cache2.aglt2.org                                                               11
cache3.aglt2.org                                                               2
cithep251.ultralight.org                                                 240
spserv01.sprace.org.br                                                  54
iitgrid.iit.edu                                                                      159
mwt2-squid.campuscluster.illinois.edu                  26

by /DC=org/DC=opensciencegrid/O=Open Science Grid/OU=People/CN=Richard T. Jones 594</pre></div><legend>Similar Recent Tickets <small>modified within the last 30 days</small></legend><div id="similar_tickets"><p class="muted">No similar tickets found.</p></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F34479">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

    //enable autocomplete for search box
    $("#search").autocomplete({
        source: function( request, response ) {
            $.ajax({
                url: "search/autocomplete",
                dataType: "text",
                data: {
                    //featureClass: "P",
                    //style: "full",
                    //maxRows: 12,
                    //name_startsWith: request.term
                    q: request.term
                },
                success: function( data ) {
                    response( $.map( data.split("\n"), function( item ) {
                        if(item == "") return null;
                        return {
                            value: item
                        }
                    }));
                }
            });
        },
        select: function(event, ui) {
            document.location = "search?q="+ui.item.value;
        }
    });
    
});
</script>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-69012-13");
pageTracker._trackPageview();
} catch(err) {}
</script>

</body>
