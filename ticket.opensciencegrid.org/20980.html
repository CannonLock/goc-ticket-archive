<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[20980] GratiaWeb timing out (proxy error)</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="robots" content="noindex, nofollow" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=20980" method="post">
<div class="page-header">
    <h3><span class="muted">20980</span> / GratiaWeb timing out (proxy error)</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">Marco Mambelli (cern)</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    <div class="control-group"><label class="control-label">Submitted Via</label><div class="controls">GOC Ticket/submit</div></div><div class="control-group"><label class="control-label">Submitter</label><div class="controls">Marco Mambelli (cern)</div></div>
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls">ENG Action</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2014-05-02</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Scott Teige <span class="muted"> / OSG Operations Infrastructure</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/20980", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src=\""+this.thumbnail_url+"\"/></td>";
            html += "<td><a href=\""+this.url+"\" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='20980#1399311156'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T17:32:36+00:00">May 5, 2014 05:32 PM UTC</time> by <b>Soichi Hayashi</b><a class="anchor" name="1399311156">&nbsp;</a></div><pre>I meant <a href='https&#58;//ticket.grid.iu.edu/20881' target='_blank' rel='nofollow'>https&#58;//ticket.grid.iu.edu/20881</a></pre></div><div class='update_description'><i onclick="document.location='20980#1399311130'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T17:32:10+00:00">May 5, 2014 05:32 PM UTC</time> by <b>Soichi Hayashi</b><a class="anchor" name="1399311130">&nbsp;</a></div><pre>Let&#39;s move this discussion to this ticket &#62; <a href='https&#58;//ticket.grid.iu.edu/20980' target='_blank' rel='nofollow'>https&#58;//ticket.grid.iu.edu/20980</a></pre></div><div class='update_description'><i onclick="document.location='20980#1399310651'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T17:24:11+00:00">May 5, 2014 05:24 PM UTC</time> by <b>wbhurst@....</b><a class="anchor" name="1399310651">&nbsp;</a></div><pre>Hello Soichi,

I am not having any proxy-error issues, so there isn&#39;t a way for me to
recreate the problem.

Neither the database connectivity, nor the default queries have changed
since the code was originally created. I was just proposing an method of
improving the operational capabilities of the software.

Can we identify what is different about how the new database is handling
the connectivity and queries?

Best Regards,
Brad Hurst

On Mon, 2014-05-05 at 16&#58;00 +0000, Open Science Grid FootPrints wrote&#58;
<font color='#7F7E6F'>&#62; [Duplicate message snipped]</font></pre></div><div class='update_description'><i onclick="document.location='20980#1399308511'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T16:48:31+00:00">May 5, 2014 04:48 PM UTC</time> by <b>Marco Mambelli</b><a class="anchor" name="1399308511">&nbsp;</a></div><pre>Is this the right ticket to follow up or should the discussion be moved to <a href='https&#58;//ticket.grid.iu.edu/20881?' target='_blank' rel='nofollow'>https&#58;//ticket.grid.iu.edu/20881?</a></pre></div><div class='update_description'><i onclick="document.location='20980#1399308405'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T16:46:45+00:00">May 5, 2014 04:46 PM UTC</time> by <b>Marco Mambelli</b><a class="anchor" name="1399308405">&nbsp;</a></div><pre>All tests on the DB return responsive and the load on the DB is low. Some queries are slow, but not slower than with the previous database.
We will optimize the indexes but it would be nice to understand why GratiaWeb starts hanging after a while. Slow queries should not cause that. There will always be users asking for yearly summaries or other unusually intense and slow queries.

Soichi found some failed attempts to connect to gratia_events DB. There is no gratia_events DB. I opened a Jira ticket about this&#58; <a href='https&#58;//jira.opensciencegrid.org/browse/GRATIAWEB-52' target='_blank' rel='nofollow'>https&#58;//jira.opensciencegrid.org/browse/GRATIAWEB-52</a>

By the way, which is the code version of GratiWeb?

Thank you,
Marco</pre></div><div class='update_description'><i onclick="document.location='20980#1399305634'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T16:00:34+00:00">May 5, 2014 04:00 PM UTC</time> by <b>Soichi Hayashi</b><a class="anchor" name="1399305634">&nbsp;</a></div><pre><font color='#7F7E6F'>&#62; I think these queries could be removed from the code, so that gratiaweb would continue to run without the database connectivity.</font>
I think this is a step in the right direction. Are you CC-ed on Fermi SNOW ticket INC000000411846? I think you should look into implementing SQL optimization suggested by RDX analyst (report is attached on the SNOW ticket).

For now, we are seeing an issue where GratiaWeb will display &#34;Proxy Error&#34; permanently after some period of operations. Scott mentioned that he had to restart gratiaweb1/2 several times during the last weekend. I am not sure how much of this issue is related to Fermi DB upgrade, but GratiaWeb shouldn&#39;t start causing a permanent proxy error regardless of the DB issue. Are you able to recreate this issue on your test instance?</pre></div><div class='update_description'><i onclick="document.location='20980#1399300761'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T14:39:21+00:00">May 5, 2014 02:39 PM UTC</time><a class="anchor" name="1399300761">&nbsp;</a></div><pre>Hello Soichi,

Sure. I will be glad to help.

Your query timeout value can be found in &#34;/usr/lib/python?/site-packages/gratia/config/prod.conf&#34;.  My current value is 1800 seconds, or 30 minutes. This is the historic value. I can understand how a 30 minute timeout on a query can make the gratiaweb software responsiveness to be &#34;sluggish&#34;. If you would like to reduce this response time, then it is possible to reduce this value in the &#34;prod.config&#34; file, mentioned above.  Once the change is made to the file, a restart of the server will implement the value in your current processes.  Some tuning of this query response time in relation to database responsiveness would be quite beneficial.

It is my belief that reducing this value will just make it fail sooner. I think a biggest portion of the problem is that the software performs a few &#34;default&#34; queries of the database, no matter what page you are trying to view. If the database connectivity is not there, then the whole package fails. This is what you saw last week when the database was shutdown, so was gratiaweb. I think these queries could be removed from the code, so that gratiaweb would continue to run without the database connectivity. Then it would fail, when you attempted to activate a page link that required a level of database connectivity that was not present. This would be a much more &#34;graceful&#34; approach to the gratiaweb software operation.

As for improving the gratiaweb error handling capabilities, I made some efforts at improving them in my last set of updates. It has been my goal to continue to make these types of improvements as time permits.

Hopefully this will help to answer some of the questions.

Best Regards,
Brad Hurst

by /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=William B Hurst 1156</pre></div><div class='update_description'><i onclick="document.location='20980#1399297207'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-05T13:40:07+00:00">May 5, 2014 01:40 PM UTC</time> by <b>Soichi Hayashi</b><a class="anchor" name="1399297207">&nbsp;</a></div><pre>Re-opening this ticket.

Brad,
I am sending you the latest alerts we are receiving from gratiaweb.</pre></div><div class='update_description'><i onclick="document.location='20980#1399061280'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-02T20:08:00+00:00">May 2, 2014 08:08 PM UTC</time> by <b>Soichi Hayashi</b><a class="anchor" name="1399061280">&nbsp;</a></div><pre>I am CC-ing Brad Hurst on this ticket.

Brad,

It is becoming clear to us that, we need some kind of mechanism to prevent GratiaWeb from going unresponsive in case of partial or complete DB outage. The proxy error also occurs when Gratia DB is slow with responding with the query result. We should probably increase the Apache proxy timeout, or implement some mechanism so that GratiaWeb can handle this case more gracefully. Will you comment?

Soichi</pre></div><div class='update_description'><i onclick="document.location='20980#1399059339'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-02T19:35:39+00:00">May 2, 2014 07:35 PM UTC</time> by <b>Scott Teige</b><a class="anchor" name="1399059339">&nbsp;</a></div><pre>Hello,
I bounced gratiaweb2 and it is back to normal. Looks to me like gratia is not yet fully repaired, I&#39;ll keep an eye on things over the weekend.
There are several tickets on this already, closing this one.
S</pre></div><div class='update_description'><i onclick="document.location='20980#1399057477'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2014-05-02T19:04:37+00:00">May 2, 2014 07:04 PM UTC</time> by <b>OSG-GOC</b><a class="anchor" name="1399057477">&nbsp;</a></div><pre>Greetings,
gratiaweb2.grid.iu.edu seems to be unresponsive and timing out all requests.
This causes many of gratiaweb.grid.iu.edu to timeout as well.
gratiaweb1 (that yesterday seem to have problems) seem to work fine today.

The alias gratiaweb.grid.iu.edu seems to increase problems instead of increasing reliability&#58;
- yesterday gratiaweb1 was down and gratiaweb was giving proxy errors
- today gratiaweb2 is having problem and gratiaweb is timing out again

Best,
Marco Mambelli

by /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Marco Mambelli</pre></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F20980">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

});
</script>


</body>
