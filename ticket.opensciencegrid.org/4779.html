<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[4779] dCache - question about dCache JVMs</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=4779" method="post">
<div class="page-header">
    <h3><span class="muted">4779</span> / dCache - question about dCache JVMs</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">Neha Sharma</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls"></div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2008-05-12</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Rob Quick <span class="muted"> / OSG GOC Management</span></div><div class="assignee" style="width: 60%">Neha Sharma <span class="muted"> / OSG Storage Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/4779", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src=\""+this.thumbnail_url+"\"/></td>";
            html += "<td><a href=\""+this.url+"\" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='4779#1208894100'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2008-04-22T19:55:00+00:00">Apr 22, 2008 07:55 PM UTC</time> by <b>Neha Sharma</b><a class="anchor" name="1208894100">&nbsp;</a></div><pre>Thanks. 807M is reasonable for this code when specifying 512M in
the java options. Are there any pools at ~2000M that you can try
this on?

None yet, though the size appears to increase steadily. I&#39;ll keep my
eye out for larger ones.

Hi Ted-

Sorry for the delay in getting back to you!

On Fri, Mar 21, 2008 at 01&#58;47&#58;23PM -0500, Ted Hesselroth wrote&#58;
You can check the memory size with &#39;top&#39; also, so see if it goes
down.  That said, I am not sure all the extra memory will be
released, since it is not subject to garbage collection. If the
memory use stays high even when the queue sizes are small, I&#39;d
consider that a problem.

I tested this on a few pools this morning. On one typical pool,
memory usage before the test was 807M vsize (76M resident). After
disabling the pool and checking that the queues were empty, I
observed no immediate reduction in vsize or resident. 30 minutes
later, resident had shrunk to 23M while vsize had increased to 808M.
Before the test, this pool&#39;s vsize had been increasing at a rate of
2.5M/hour.

In the last 24 hours, various pools have been restarted by an
automated reaper I wrote to catch the large pool sizes. I expect
that the reaper will catch more in the near future.

Is this information useful? If there are other details that would
help debug this issue, I&#39;m happy to dig them up, too.

Thanks!

<div id='show_1562183326' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_1562183326'>On Wed, Apr 09, 2008 at 11&#58;49&#58;59AM -0500, Neha Sharma wrote&#58;
How did the dCache upgrade go?

The upgrade went well; we were able to switch architectures (32 -&#62;
64) without any trouble. The PNFS database runs _much_ faster on the
new 64 bit machines which has led to a ~6-10x improvement in some
operations. We&#39;re quite pleased. ;)

Any updates on this problem?

None, unfortunately. Dan is now on vacation so my time is a bit
thin. I hope to return to it when Dan returns.

Thanks!
</div><script type='text/javascript'>
        $('#show_1562183326').click(function() {
            $('#detail_1562183326').slideDown("normal");
            $('#show_1562183326').hide();
            $('#hide_1562183326').show();
        });
        $('#hide_1562183326').click(function() {
            $('#detail_1562183326').slideUp();
            $('#hide_1562183326').hide();
            $('#show_1562183326').show();
        });
        </script></pre></div><div class='update_description'><i onclick="document.location='4779#1206545080'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2008-03-26T15:24:40+00:00">Mar 26, 2008 03:24 PM UTC</time> by <b>Neha Sharma</b><a class="anchor" name="1206545080">&nbsp;</a></div><pre>Thanks for this suggestion -- we&#39;ll give it a try soon. I wrote a
quick script that records the amounts of virtual and resident memory
used by the JVM as well as the number of threads (as reported by the
proc(5) filesystem). While the number of active threads (at this
level, at least) fluctuates between 30 and 35, size and res
increase at a constant rate&#58; approximately 1.2M/hour.

This accumulation has been constant over ~36 hours. I&#39;ll continue to
observe the JVMs and, when I can, I&#39;ll try your suggestion as well.

Thanks again!</pre></div><div class='update_description'><i onclick="document.location='4779#1206476921'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2008-03-25T20:28:41+00:00">Mar 25, 2008 08:28 PM UTC</time> by <b>Neha Sharma</b><a class="anchor" name="1206476921">&nbsp;</a></div><pre>One experiment to try would be to disable the pool and check whether the queue sizes go down, using some of
the commands from the &#34;Renaming a Pool&#34; section of the dCache Book.

<a href='http&#58;//www.dcache.org/manuals/Book/cookbook/cb-pool-rename.shtml' target='_blank' rel='nofollow'>http&#58;//www.dcache.org/manuals/Book/cookbook/cb-pool-rename.shtml</a>

where it says
(&#60;poolname&#62;) admin &#62; pool disable -strict
Then make sure, no transfers are being processed anymore. All the following commands should give no output&#58;

(&#60;poolname&#62;) admin &#62; queue ls queue
(&#60;poolname&#62;) admin &#62; mover ls
(&#60;poolname&#62;) admin &#62; p2p ls
(&#60;poolname&#62;) admin &#62; pp ls
(&#60;poolname&#62;) admin &#62; st jobs ls
(&#60;poolname&#62;) admin &#62; rh jobs ls

and then re-enable the pool with &#34;pool enable&#34;.

You can check the memory size with &#39;top&#39; also, so see if it goes down. That said, I am not sure all the extra
memory will be released, since it is not subject to garbage collection. If the memory use stays high even when
the queue sizes are small, I&#39;d consider that a problem.

Ted

Hi Ted-

On Wed, Mar 19, 2008 at 04&#58;06&#58;45PM -0500, Ted Hesselroth wrote&#58;
There are various ways for the memory of a java application to go
above the specified heap size. In addition to the heap, there will
be a stack size for each thread, and also the size of the jvm
itself, executed as native calls. Also, when NIO is used (as for
pools) it allocates memory independently. The control for the last
of these is via -XX&#58;MaxDirectMemorySize, which in dCacheSetup is
set to 512m by default.  The stack size per thread is 1m by
default on a 64-bit architecture. So if you have -Xmx=600m, and a
<div id='show_628110295' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_628110295'>few hundred MB for the jvm, plus hundreds of threads with NIO and
stack sizes, I can see getting up to 2000m.

This makes sense -- thanks (to you and Timur) for the great summary.
I don&#39;t see though, based on the scenario you outlined above, why
our JVMs should reach and then maintain such a high level of memory
usage. Wouldn&#39;t this indicate that threads aren&#39;t releasing their
memory back to the system?

You can try decreasing the number of allowed threads, or the stack
size with Xss. MaxDirectMemorySize is optional; the memory can be
handled by the garbage collector if it is not set. You can also
run multiple pools in the same JVM. All of these will diminish
performance.

We had previously run our pools in a single JVM and moved away from
that in order to improve performance. Dan and I had been wondering
if that was still the recommended approach; I&#39;m glad to hear it
confirmed.

I would be interested to know if you have any evidence that
threads are hanging around longer than they should.

Agreed. What kind of evidence -- beyond gross estimates of
virtual/resident memory usage of the JVM itself over time -- can we
provide? Based on my limited understanding, the observed
accumulation of memory over time suggests that _something_ isn&#39;t
quite right.

Thanks!
</div><script type='text/javascript'>
        $('#show_628110295').click(function() {
            $('#detail_628110295').slideDown("normal");
            $('#show_628110295').hide();
            $('#hide_628110295').show();
        });
        $('#hide_628110295').click(function() {
            $('#detail_628110295').slideUp();
            $('#hide_628110295').hide();
            $('#show_628110295').show();
        });
        </script></pre></div><div class='update_description'><i onclick="document.location='4779#1205966291'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2008-03-19T22:38:11+00:00">Mar 19, 2008 10:38 PM UTC</time> by <b>Neha Sharma</b><a class="anchor" name="1205966291">&nbsp;</a></div><pre>There are various ways for the memory of a java application to go above the specified heap size. In addition to
the heap, there will be a stack size for each thread, and also the size of the jvm itself, executed as native calls.
Also, when NIO is used (as for pools) it allocates memory independently. The control for the last of these is via -
XX&#58;MaxDirectMemorySize, which in dCacheSetup is set to 512m by default. The stack size per thread is 1m by
default on a 64-bit architecture. So if you have -Xmx=600m, and a few hundred MB for the jvm, plus hundreds
of threads with NIO and stack sizes, I can see getting up to 2000m.

You can try decreasing the number of allowed threads, or the stack size with Xss. MaxDirectMemorySize is
optional; the memory can be handled by the garbage collector if it is not set. You can also run multiple pools in
the same JVM. All of these will diminish performance.

I would be interested to know if you have any evidence that threads are hanging around longer than they
should.

My thanks to Timur for some of the above info on Java memory.

Ted

Will Maier wrote&#58;
Today, Dan observed two dCache JVMs eating up lots of virtual memory
(~2000M) each. Our pools are configured with ~600M of heap, which is
more or less the amount of resident memory consumed by the JVMs when
Dan caught them. In this case, the exhaustion of vmem prevented the
system from swapping and left it in a weird limbo.

Anecdotally, the virtual size of our dCache JVMs appears to grow
over time. Is this known/observed elsewhere? Can we expect the JVMs
to keep their virtual and resident memory under the heap size limits
we set in our pool configs?

Thanks!</pre></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F4779">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

});
</script>


</body>
