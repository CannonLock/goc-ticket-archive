<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[25983] CVMFS hangs worker nodes</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <link href="https://ticket.opensciencegrid.org/rss" rel="alternate" type="application/rss+xml" title="GOC Ticket Update feed" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
    <script src='https://www.google.com/recaptcha/api.js'></script>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=25983" method="post">
<div class="page-header">
    <h3><span class="muted">25983</span> / CVMFS hangs worker nodes</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">John Dockendorf</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    <div class="control-group"><label class="control-label">Submitted Via</label><div class="controls">GOC Ticket/submit</div></div><div class="control-group"><label class="control-label">Submitter</label><div class="controls">John Dockendorf</div></div><div class="control-group"><label class="control-label">Ticket Links</label><div class="controls"></div></div>
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls">Waiting for User Response</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2015-07-10</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Kyle Gross <span class="muted"> / OSG GOC Support Team</span></div><div class="assignee" style="width: 60%">Dave Dykstra <span class="muted"> / OSG Security Coordinators</span></div><div class="assignee" style="width: 60%">Software Support (Triage) <span class="muted"> / OSG Software Team</span></div><div class="assignee" style="width: 60%">Tim Theisen <span class="muted"> / OSG Software Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("https://ticket.opensciencegrid.org/attachment/list?id=25983", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src="https://ticket.opensciencegrid.org/\&quot;&quot;+this.thumbnail_url+&quot;\&quot;/"></td>";
            html += "<td><a href="https://ticket.opensciencegrid.org/\&quot;&quot;+this.url+&quot;\&quot;" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
        <div class="btn-group">
                <a class="btn btn-small" href="https://ticket.opensciencegrid.org/25983?sort=up&amp;"><i class="icon-arrow-up"></i> Sort</a>

        
        <a class="btn btn-small" href="https://ticket.opensciencegrid.org/25983?expandall=true&amp;">Expand Descriptions</a>        <a class="btn btn-small" target="_blank" href="mailto:osg@tick.globalnoc.iu.edu?subject=Open%20Science%20Grid%3A%20CVMFS%20hangs%20worker%20nodes%20ISSUE%3D25983%20PROJ%3D71"><i class="icon-envelope"></i> Update w/Email</a>
        </div>
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='25983#1436282050'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-07-07T15:14:10+00:00">Jul 7, 2015 03:14 PM UTC</time><a class="anchor" name="1436282050">&nbsp;</a></div><pre>Perfect. Closing the ticket

by /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Edgar Mauricio Fajardo Hernandez 2020</pre></div><div class='update_description'><i onclick="document.location='25983#1436203008'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-07-06T17:16:48+00:00">Jul 6, 2015 05:16 PM UTC</time><a class="anchor" name="1436203008">&nbsp;</a></div><pre>I think it&#39;s fine to close the ticket.  If we still have issues after adding additional proxies then I&#39;ll create a new ticket.

Thanks,
- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='25983#1436201566'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-07-06T16:52:46+00:00">Jul 6, 2015 04:52 PM UTC</time><a class="anchor" name="1436201566">&nbsp;</a></div><pre>Hi Trey,

Were Dave&#39;s recommendation allright?

Can we close this ticket?

Cheers,

Edgar
OSG Software Support

by /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Edgar Mauricio Fajardo Hernandez 2020</pre></div><div class='update_description'><i onclick="document.location='25983#1435630763'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-30T02:19:23+00:00">Jun 30, 2015 02:19 AM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1435630763">&nbsp;</a></div><pre>Trey,

You don&#39;t really need to remove a machine from the DNS round-robin for downtime, as both Frontier & CVMFS clients timeout quickly, within 5 seconds, and then they don&#39;t keep trying the machine that&#39;s down.  They try once every 5 minutes.

The behavior of CVMFS & Frontier clients with respect to round-robin depends on the version number.   cvmfs-2.1.19 and earlier will not try a second proxy in a round-robin, but cvmfs-2.1.20 will.  The older versions need to list the two proxies with a vertical bar between them.  Frontier client has used all IPs in a round-robin since version 2.8.6 from April 2013, so it should be pretty safe that all CMS software by now is running that version.  Just in case, people usually list the round-robin first and then each separate proxy.  Alternatively you can let the frontier client do its own load balancing by listing each one separately and adding the load balance=proxies option.  (That load balancing does not include backup proxies, they&#39;re tried after all regular proxy urls).

Regarding the public interface, very little traffic flows between squid and stratum 1s.  Higher bandwidth doesn&#39;t help that link.  It&#39;s the internal link between squid and your worker nodes that needs the higher bandwidth.

Dave</pre></div><div class='update_description'><i onclick="document.location='25983#1435418365'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-27T15:19:25+00:00">Jun 27, 2015 03:19 PM UTC</time><a class="anchor" name="1435418365">&nbsp;</a></div><pre>Hi,

In response to Dave (also responded similarly to a private email)&#58;

<font color='#7F7E6F'>&#62; Oh, this makes me wonder if the bnl stratum 1 might also have collapsed forwarding enabled, it could very well be. It is not enabled at fnal. If they have collapsed forwarding enabled there, it could be that other slow clients at other sites are slowing your site down. I added the bnl stratum 1 administrator on the ticket. John, have you disabled collapsed forwarding in your stratum 1 frontier-squid configuration? I did that long ago at fnal but may have not spread that suggestion to you. You have your squids on different machines so it wasn&#39;t as obviously the right thing to do as at fnal where we have the squid and apache on the same machine, but it is probably the right thing to do for cvmfs.</font>

<font color='#7F7E6F'>&#62; If collapsed forwarding is enabled on the BNL stratum 1, you may be being slowed down by slow clients at other sites that were reading at the same time.</font>

Collapsed forwarding is disabled on the BNL CVMFS Stratum One Squids&#58;

# grep collapsed_forwarding /etc/squid/squid.conf|grep -v ^#
collapsed_forwarding off

~John

by /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=John S. De Stefano Jr.</pre></div><div class='update_description'><i onclick="document.location='25983#1435347115'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-26T19:31:55+00:00">Jun 26, 2015 07:31 PM UTC</time><a class="anchor" name="1435347115">&nbsp;</a></div><pre>Thanks for the recommendations.  I guess the only issue I see with using DNS round-robin is the actual failover in the event a squid proxy is down.  If the down state is planned then I can imagine a manual update of the DNS records could allow failover.  For unplanned outages I assume that would rely on our monitoring modifying the DNS records, which is within the realm of possibility but not something we currently are doing.

Is the DNS round-robin approach primarily for CVMFS usage, and not Frontier?  I notice the docs for site-local-config.xml document round-robin being achieved by specifying multiple proxies in the XML.

My references to &#34;public&#34; are referring to the squid proxy&#39;s interface that pulls the data from stratum 1 servers.  So the proxy talks to the stratum 1 servers via the public interface and all compute nodes talk to the proxy via the private interface.

Thanks,
- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='25983#1435345149'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-26T18:59:09+00:00">Jun 26, 2015 06:59 PM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1435345149">&nbsp;</a></div><pre>I would recommend two or three 1gbps physical machines.  You&#39;re always going to need at least two so one can handle the load while the other is down for whatever reason.

VMs can be OK too, if you carefully engineer the mix of applications on a single hypervisor so they don&#39;t interfere with each other.  If there&#39;s more than one application that can sometimes take a very large fraction of the network or disk, you&#39;re asking for trouble.  If there&#39;s only one, or if they all are limited in the portion of those shared resources they can take, it should be OK.

I don&#39;t understand what you mean by &#34;public connetivity&#34;, since all your squid accesses should be from your site.</pre></div><div class='update_description'><i onclick="document.location='25983#1435343986'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-26T18:39:46+00:00">Jun 26, 2015 06:39 PM UTC</time><a class="anchor" name="1435343986">&nbsp;</a></div><pre>I&#39;ve updated squid to 2.7.STABLE9-21.1.osg32.el6.  There are about 3100 job slots available for single-core jobs.  For such a situation, would it be better to have a single dedicated 8-core server with 10Gbps public connectivity run multiple squid proxies, or run multiple dedicated 1Gbps squid proxies?  Would a VM pose any problems for running frontier-squid?  The VMs would have 10Gbps to both private and public networks and can be distributed across two hypervisors.

I am in the process of pushing out an update to the CVMFS_SERVER_URL value so that FNAL is listed first.

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='25983#1435278948'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-26T00:35:48+00:00">Jun 26, 2015 12:35 AM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1435278948">&nbsp;</a></div><pre>Yes I was talking about DNS round-robin.

A better URL for fnal is &#34;<a href='http&#58;//cvmfs.fnal.gov&#58;8000/opt/' target='_blank' rel='nofollow'>http&#58;//cvmfs.fnal.gov&#58;8000/opt/</a>@org@&#34;.

If collapsed forwarding is enabled on the BNL stratum 1, you may be being slowed down by slow clients at other sites that were reading at the same time.  If it doesn&#39;t, or if you switch to fnal first, you would be only slowed down by clients at your own site.   It is best for collapsed forwarding to be on at sites, but not at stratum 1s.

How many job slots do you have?  Two standalone 1gbit/s servers is likely to be the best choice, and leave the 10Gbps to gridftp.  If most of your worker nodes go through the 1Gbps internal connection anyway, you won&#39;t be reducing their available bandwidth.  Besides, a single squid process usually can not handle more than a couple hundred MB/s, if that.  For 10Gbps throughput we usually run more squid processes.  The disk is not usually the bottleneck, since most of the requests are repeats and come from the kernel filesystem buffer cache on the squid machines.</pre></div><div class='update_description'><i onclick="document.location='25983#1435260994'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-25T19:36:34+00:00">Jun 25, 2015 07:36 PM UTC</time><a class="anchor" name="1435260994">&nbsp;</a></div><pre>Also, the 100MB/s may be the speed of local disks for our squid server.  The server itself has a 10Gbps public connection, a 1Gbps internal connection and ~16Gbps internal IB connection.  The clients using CVMFS in this case were all 1Gbps to the squid server.  Some nodes contact squid using IPoIB which is around 16Gbps, but those systems were not the ones we saw hanging.

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='25983#1435260282'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-25T19:24:42+00:00">Jun 25, 2015 07:24 PM UTC</time><a class="anchor" name="1435260282">&nbsp;</a></div><pre>Dave,

Thanks for taking a look and the recommendations.

I will definitely begin planning adding more squid servers.  Right now our squid server is also the GridFTP server, so isolating squid to its own system seems like something to move towards.  The round-robin you speak of, is that something specific to CVMFS / Frontier or are you speaking of DNS round-robin?  Right now our squid service is a CNAME associated to the actual server, so if DNS round-robin is the method for utilizing multiple squid servers, then it&#39;s very much within the realm of something we can do on our internal BIND systems.

I&#39;ll also work towards upgrading squid, especially if it improves the logging.  Right now our /etc/cvmfs/domain.d/cern.ch.local has &#39;CVMFS_SERVER_URL=&#34;<a href='http&#58;//cvmfs.racf.bnl.gov&#58;8000/opt/' target='_blank' rel='nofollow'>http&#58;//cvmfs.racf.bnl.gov&#58;8000/opt/</a>@org@;<a href='http&#58;//cvmfs-stratum-one.cern.ch&#58;8000/opt/' target='_blank' rel='nofollow'>http&#58;//cvmfs-stratum-one.cern.ch&#58;8000/opt/</a>@org@;<a href='http&#58;//cernvmfs.gridpp.rl.ac.uk&#58;8000/opt/' target='_blank' rel='nofollow'>http&#58;//cernvmfs.gridpp.rl.ac.uk&#58;8000/opt/</a>@org@&#34;&#39;.  Looks like we need to update our CVMFS_SERVER_URL to include FNAL, and put that first. This would be the URL to use, &#34;<a href='http&#58;//cvmfs.fnal.gov/opt/' target='_blank' rel='nofollow'>http&#58;//cvmfs.fnal.gov/opt/</a>@org@&#34; ?  I found that in /etc/cvmfs/domain.d/cern.ch.conf.

So this collapsed forwarding would combine requests into a single request, but does this mean the slowest client at my site is the cause of a slowdown, or the slowest client in the combined request (which may have clients from other sites)?

Thanks,
- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='25983#1435243524'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-25T14:45:24+00:00">Jun 25, 2015 02:45 PM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1435243524">&nbsp;</a></div><pre>It appears that the slow down happened when reading <a href='http&#58;//cvmfs.racf.bnl.gov&#58;8000/opt/cms/data/60/d64c78fa7630a26e9b5b82753dfa3f930f87b0C.' target='_blank' rel='nofollow'>http&#58;//cvmfs.racf.bnl.gov&#58;8000/opt/cms/data/60/d64c78fa7630a26e9b5b82753dfa3f930f87b0C.</a>  The &#34;C&#34; indicates a catalog.  You don&#39;t have the latest squid which logs what path a CVMFS request comes from, but I checked a fermilab squid and it was the cms.cern.ch root catalog.  That is pretty large, 75MB compressed and 165MB uncompressed.  I&#39;ll talk to Bockjoo about making it smaller.

Looking for all occurrences of that query in your logs, I see 30 of them.  They all finished at 16&#58;19&#58;16 because collapsed forwarding combined them into a single request, as it should.  However altogether it took an extremely long time, ranging from 2282 seconds (38 minutes) down to 1618 seconds (27 minutes). The root cause could be a slow client on your end, because all of the other clients will wait due to collapsed forwarding during a download.  I would expect it to be one of the clients that took the longest if that was the situation.

One question, although this shouldn&#39;t normally make a big difference, is why it was read from BNL rather than Fermilab, since Fermilab is closer to Texas.   In cvmfs-2.1.19 the order is set by the system administrator in /etc/cvmfs/domain.d/cern.ch.local.  Do you have bnl.gov listed before fnal.gov?

Oh, this makes me wonder if the bnl stratum 1 might also have collapsed forwarding enabled, it could very well be.  It is not enabled at fnal.  If they have collapsed forwarding enabled there, it could be that other slow clients at other sites are slowing your site down.  I added the bnl stratum 1 administrator on the ticket.  John, have you disabled collapsed forwarding in your stratum 1 frontier-squid configuration?  I did that long ago at fnal but may have not spread that suggestion to you.  You have your squids on different machines so it wasn&#39;t as obviously the right thing to do as at fnal where we have the squid and apache on the same machine, but it is probably the right thing to do for cvmfs.</pre></div><div class='update_description'><i onclick="document.location='25983#1435240322'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-25T13:52:02+00:00">Jun 25, 2015 01:52 PM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1435240322">&nbsp;</a></div><pre>The +0000 time zone was corrected in frontier-squid-2.7.STABLE9-17.1.  I recommend upgrading to the latest version.

The spikes are probably a sign of high demand, not necessarily something wrong with the squid installation.

With 1000+ job slots, you should definitely have two squids if only for reliability.  Also as I said at peak times the one squid is reaching it&#39;s full capacity of 100MB/s (assuming the machine has 1gbit/s) which isn&#39;t good.  I don&#39;t recommend splitting traffic types, just have a round-robin of two squids for everything.  The squid machines should not be hosting other services either.

Your CVMFS quota limit and filesystem size are lower than the recommended 20GB, but they&#39;re probably not the cause of this since the slowdowns are correlated to new cms.cern.ch revisions.  The quota size mostly matters when you&#39;re having a large variety of different types of jobs happening close together.  If all the CMS jobs were submitted in a small number of different batches, there should be a high cache hit ratio most of the time.

I haven&#39;t looked at your log files yet, I&#39;ll do that next.  I don&#39;t need them split by IP address.</pre></div><div class='update_description'><i onclick="document.location='25983#1435188960'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-24T23:36:00+00:00">Jun 24, 2015 11:36 PM UTC</time><a class="anchor" name="1435188960">&nbsp;</a></div><pre>Dave,

Due to the size of my access logs they were split up into chunks based on timestamp, some chunks are only 30 seconds.  Also the log entries have timezone of &#34;+0000&#34; so unsure if the log time of 15&#58;45 would be my server&#39;s time or 15&#58;45 UTC.  The most recent access logs show a time of that matches my server&#39;s time but the use of +0000 is a bit confusing.

Based on my monitoring the hang of our monitoring agent on compute nodes started anywhere from 15&#58;50 CST to 16&#58;05 CST.  The end of the hang seems to be around 16&#58;20 CST, at least that&#39;s when Zabbix reported the nodes as responding again.

Here are IPs of hosts that hung for long periods of time yesterday.

192.168.200.11 -&#62; 15&#58;53 - 16&#58;21
192.168.200.12 -&#62; 15&#58;50 - 16&#58;20
192.168.200.24 -&#62; 15&#58;59 - 16&#58;20
192.168.200.27 -&#62; 16&#58;03 - 16&#58;20
192.168.200.39 -&#62; 16&#58;11 - 16&#58;20
192.168.200.110 -&#62; 16&#58;05 - 16&#58;20

Other periods where nodes hung have lasted less than 5 minutes so I don&#39;t get alerts but the event is logged in our monitoring.

If having the logs extracted on a per-IP basis would help, let me know.  I am seeing that for some of the hosts that hung the activity in access logs don&#39;t seem to correspond to when the node is hung but may correspond to another alert in relation to the space free on /var/cache/cvmfs mount point.

Are those spikes a sign of anything wrong, or just a sign of high usage / utilization of squid?  We&#39;ve had numerous CMS users submitting large batches of jobs, all using CVMFS as far as I&#39;m aware.  During this last hang there were likely close to 1,000 CMS jobs running at the same time.  We have one squid proxy and it&#39;s used for everything that needs squid (Frontier, CVMFS, etc).

Would our quota limit and/or filesystem size of CVMFS_CACHE_BASE have any effect on this issue?  We set CVMFS_QUOTA_LIMIT=8000 and during provisioning our nodes create a 10GB partition that mounts /var/cache/cvmfs which is the value used for CVMFS_CACHE_BASE.

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><div class='update_description'><i onclick="document.location='25983#1435179911'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-24T21:05:11+00:00">Jun 24, 2015 09:05 PM UTC</time> by <b>Dave Dykstra</b><a class="anchor" name="1435179911">&nbsp;</a></div><pre>Trey,

Most likely it&#39;s downloading new catalogs to all the worker nodes, which may be fairly large.  Is it possible for you to extract the access.log entries from your site&#39;s squid during the time period that you see a hang, and attach them to this ticket?   I see some pretty high throughput peaks on your squid at
<a href='http&#58;//wlcg-squid-monitor.cern.ch/snmpstats/mrtgcms/tamu/proxy-srvkbinout.html' target='_blank' rel='nofollow'>http&#58;//wlcg-squid-monitor.cern.ch/snmpstats/mrtgcms/tamu/proxy-srvkbinout.html</a>
which I assume is used by both Frontier & CVMFS.

Dave</pre></div><div class='update_description'><i onclick="document.location='25983#1435157990'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-24T14:59:50+00:00">Jun 24, 2015 02:59 PM UTC</time> by <b>Tim Theisen</b><a class="anchor" name="1435157990">&nbsp;</a></div><pre>Hey Dave,

Can you help me out with this ticket. Mat said that you might have some insight or tools to figure out what is going on here.

...Tim</pre></div><div class='update_description'><i onclick="document.location='25983#1435095243'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2015-06-23T21:34:03+00:00">Jun 23, 2015 09:34 PM UTC</time> by <b>OSG-GOC</b><a class="anchor" name="1435095243">&nbsp;</a></div><pre>I don&#39;t know if I should post this issue here, or on the CVMFS issue tracker, but since I installed cvmfs from the OSG repos, figured here is where I&#39;d start.

I have been noticing that occasionally CVMFS will bring my compute nodes to a complete standstill for several minutes.  During these times a &#34;ps aux&#34; will run and get hung before completing and even CTRL+C doesn&#39;t stop the ps command.  I&#39;m guessing ps is hanging on processes using /cvmfs.  I noticed around this same time an entry like this in /var/log/messages&#58;

Jun 23 16&#58;19&#58;16 c0419 cvmfs2&#58; (cms.cern.ch) switched to catalog revision 12996

The hang only seems to last for a couple minutes but typically affects many compute nodes all at the same time.  These compute nodes are typically running numerous CMS jobs that use CVMFS.  We use NHC (Node Health Check) to ensure compute nodes are healthy and that program will look at active processes and it ends up hanging (when reading procfs) and numerous compute nodes end up being marked &#34;Offline&#34; during these periods.

Thanks,
- Trey

by /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=jdockend/CN=750323/CN=John Lloyd Iii Dockendorf</pre></div><legend>Similar Recent Tickets <small>modified within the last 30 days</small></legend><div id="similar_tickets"><p class="muted">No similar tickets found.</p></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F25983">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script src="https://ticket1.grid.iu.edu:8443/socket.io/socket.io.js"></script>
<script>
var chat = io.connect('https://ticket1.grid.iu.edu:8443');
chat.on('connect', function() {
    chat.emit('authenticate', {nodekey:'', ticketid: 25983});
});
chat.on('peers', function(peers) {
    $("#peers").html("");
    for(var pid in peers) {
        var peer = peers[pid];
        addPeer(pid, peer);
    }
});
chat.on('peer_disconnect', function(pid) {
    $("#peer_"+pid).hide("slow");
});
chat.on('peer_connected', function(peers) {
    //expect only 1 peer connecting, but..
    for(var pid in peers) {
        var peer = peers[pid];
        addPeer(pid, peer);
    }
});
chat.on('submit', function() {
    if(confirm("This ticket was updated. Do you want to refresh?")) {
        history.go(0);
    }
});

function addPeer(pid, peer) {
    var ipinfo = "";
    if(peer.ip != undefined) {
        ipinfo = "<span class=\"ip\">"+peer.ip+"</span>";
    }
    if(chat.io.engine.id == pid) {
        //don't display myself
        return;
    }
    var html = "<li class=\"new\" id=\"peer_"+pid+"\" class=\"peer\">"+peer.name+ipinfo+"</li>";
    $("#peers").prepend(html);
    $("#peers .new").animate({bottom: 0}, 1000, function() {$(this).removeClass("new")});
}

$(function() {
    $("#ticket_form").submit(function() {
        chat.emit('submit');
        return true;
    });
});
</script>
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

    //enable autocomplete for search box
    $("#search").autocomplete({
        source: function( request, response ) {
            $.ajax({
                url: "search/autocomplete",
                dataType: "text",
                data: {
                    //featureClass: "P",
                    //style: "full",
                    //maxRows: 12,
                    //name_startsWith: request.term
                    q: request.term
                },
                success: function( data ) {
                    response( $.map( data.split("\n"), function( item ) {
                        if(item == "") return null;
                        return {
                            value: item
                        }
                    }));
                }
            });
        },
        select: function(event, ui) {
            document.location = "search?q="+ui.item.value;
        }
    });
    
});
</script>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-69012-13");
pageTracker._trackPageview();
} catch(err) {}
</script>

</body>
