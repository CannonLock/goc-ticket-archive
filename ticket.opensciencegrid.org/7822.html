<!DOCTYPE html>
<html lang="en">
  <head>
  <base href="">
    <title>[7822] OSG Storage&#58; Xrootd&#58; Draining xrood server</title>    <meta charset="utf-8" />
    <meta name="verify-v1" content="na5IcAJsZVOfEkboRxuIiZ1zpZgnZiWra+nKcS7nA/o=" />
    <meta name="google-site-verification" content="DLrk3ft4s8b-S2TloLCL2LD_t6wcTjgSluf5pmiu2kA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <link href="https://ticket.opensciencegrid.org/rss" rel="alternate" type="application/rss+xml" title="GOC Ticket Update feed" />

    <style type="text/css">
      body {
        padding-top: 50px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
     #search {
            width: 300px;
     }

    </style>

<script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://code.jquery.com/jquery-migrate-3.0.1.js"></script>

   <link href="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>

    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.2/js/select2.min.js"></script>

    <link href="css/ticket.css" rel="stylesheet" />
    <script src="lib/jquery.cookie.js"></script>

    <link href="images/tag_orange.png" rel="icon" type="image/png"/>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <a class="brand" style="padding: 6px 0px 0px 6px;" href="http://opensciencegrid.org"><img src="images/osglogo.40x30.png"/></a>
            <ul class="nav">
                <li class="dropdown"><a href="https://ticket.opensciencegrid.org/#" class="dropdown-toggle" data-toggle="dropdown">GOC Ticket <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    <li><a href="https://my.opensciencegrid.org">MyOSG</a></li>
                    <li><a href="https://oim.opensciencegrid.org">OIM</a></li>
                    <li class="active"><a href="https://ticket.opensciencegrid.org/index">Ticket</a></li>
	<li class="divider"></li>
	<li><a href="http://repo.grid.iu.edu">Repo</a></li>
	<li class="divider"></li>
	<li><a href="http://blogs.grid.iu.edu">Blog</a></li>
                    <li><a href="http://display.grid.iu.edu">Display</a></li>
                    <li><a href="http://osggoc.blogspot.com/">News</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav pull-right">
                <li><a href="https://ticket.opensciencegrid.org/sso/">Login</a></li>            </ul>

            <div class="nav-collapse">
                <ul class="nav">
			 <li id="menu_submit"><a href="https://ticket.opensciencegrid.org/submit">Submit</a></li><li id="menu_view" class="dropdown"><a href="https://ticket.opensciencegrid.org/\#" class="dropdown-toggle" data-toggle="dropdown">View <b class="caret"></b></a><ul class="dropdown-menu"><li id="submenu_listopen"><a href="https://ticket.opensciencegrid.org/list/open">Open Tickets</a></li><li id="submenu_listrecentclose"><a href="https://ticket.opensciencegrid.org/list/recentclose">Recently Closed Tickets</a></li><li class="divider"></li><li id="submenu_alltickets"><a href="https://ticket.opensciencegrid.org/search?q=&amp;sort=id">All Tickets</a></li></ul></li>                </ul>

                <form class="navbar-search pull-right" action="https://ticket.opensciencegrid.org/viewer">
                    <input id="search" type="text" name="id" class="search-query span2" placeholder="Search Ticket" value=""/>
                </form>
            </div>
        </div>
      </div>
    </div>

<script type='text/javascript' src='lib/jquery.timeago.js'></script>
<script type='text/javascript' src='lib/byte2size.js'></script>
<style>
#updates .toolbar {
position: relative;
margin-top: 0px;
top: -10px;
font-weight: normal;
}
#updates a.anchor {
position: relative;
top: -50px;
}
#updates .selected pre {
animation:selected 2s;
animation-iteration-count: 2;
animation-direction: alternate;
-webkit-animation:selected 2s; 
-webkit-animation-iteration-count: 2;
-webkit-animation-direction: alternate;
box-shadow: inset 1px 1px 20px #9ad;
border: 1px solid #9ab;
margin: 5px 0px;
padding-left: 10px;
}
@keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ab;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
@-webkit-keyframes selected {
    from  {
        box-shadow: inset 1px 1px 20px #9ad;
        border: 1px solid #9ad;
    }
    to {
        box-shadow: inset 1px 1px 20px #05c;
        border: 1px solid #05c;
    }
}
#updates pre {
background-color: inherit;
line-height: 15px;
padding: 5px;
}
#updates .header {
color: #999;
}
#updates .update_history pre {
background-color: #eee;
color: #666;
font-size: 85%;
}
#updates .clickable {
cursor: pointer;
}
#updates .clickable:hover {
color: #D98719;
}
#updates .meta_information pre {
background-color: #fed;
}
#similar_tickets {
max-height: 300px;
overflow-y: auto;
pointer-events: none;
padding: 5px;
background-color: #f4f4f4;
}
.btn-toolbar {
margin-bottom: 0;
height: 30px;
}
#peers {
position: fixed;
bottom: 0px;
right: 0px;
z-index: 100;
list-style: none;
padding: 5px 0px 0px 5px;
margin: 0px;
background-color: white;
box-shadow: 0px 0px 10px white;
}
#peers li {
background-color: #ccc;
color: #000;
display: inline-block;
padding: 5px 10px;
margin-right: 5px;
position: relative;
}
/*
#peers li:hover {
background-color: #999;
cursor: pointer;
}
*/
#peers span.ip {
padding-left: 5px;
color: #666;
}
#peers .new {
bottom: -30px;
}
/*
#peers .me {
background-color: red;
}
*/
</style>

<div class="container-fluid">
<ul id="peers"></ul>
<div class="alert alert-danger"><a class="close" href="https://ticket.opensciencegrid.org/#" data-dismiss="alert">&times;</a>By the end of May 2018, the ticketing system at https://ticket.opensciencegrid.org will be retired and support will be provided at https://support.opensciencegrid.org. Throughout this transition the support email (help@opensciencegrid.org) will be available as a point of contact.<br><br>                                                   
                                                                                                                                                                                   
Please see the service migration page for details: https://opensciencegrid.github.io/technology/policy/service-migrations-spring-2018/#ticket</div><div id="presence" class="pull-right"></div><div class="ticketgui"><script type="text/javascript" src="lib/checktab.js"></script>

<script>
var expanded = false;
function expand_description() {
    var desc = $(".description");
    if(!expanded) {
        expanded = true;
        //expand to minheight
        var min = 250;
        if(desc.height() < min) {
            desc.animate({height: min}, 200);
        }
    }
}

$(document).ready(function() {
    $("input[name='nad']").datepicker({
        dateFormat: 'yy-mm-dd'
    });
});

</script>



<style>
.form-horizontal .control-label {
padding-top: inherit;
font-size:90%;
color:#666;
}
label {
margin-bottom: 0px;
}
.controls {
line-height: 18px;
}
</style>
<form class="form-horizontal" action="https://ticket.opensciencegrid.org/viewer/updatebasic?id=7822" method="post">
<div class="page-header">
    <h3><span class="muted">7822</span> / OSG Storage&#58; Xrootd&#58; Draining xrood server</h3>
</div>

<div class="row-fluid">
<div class="span5">
    <legend>Contact</legend>
    <div class="control-group">
        <label class="control-label">Full Name</label>
        <div class="controls">neha sharma</div>
    </div>
    <div class="control-group">
        <label class="control-label">Email</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Phone</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>
    <div class="control-group">
        <label class="control-label">CC</label>
        <div class="controls">
            <i class="icon-lock"></i>        </div>
    </div>

    <legend>Details</legend>
    
    <div class="control-group">
        <label class="control-label">Ticket Type</label>
        <div class="controls">Problem/Request</div>
    </div>
    <div class="control-group">
        <label class="control-label">Priority</label>
        <div class="controls">Normal</div>
    </div>
    <div class="control-group">
        <label class="control-label">Status</label>
        <div class="controls">
Closed</div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action</label>
        <div class="controls"></div>
    </div>
    <div class="control-group">
        <label class="control-label">Next Action Deadline</label>
        <div class="controls flag_red">2009-12-23</div>
    </div>

</div><!--span-->
<div class="span7">
    <legend>Assignees</legend>
    <div class="assignee" style="width: 60%">Neha Sharma <span class="muted"> / OSG Storage Team</span></div>    <br>

    <legend>Assignees</legend>
    TODO
    <br>

    <style>
legend.noborder {
border-bottom: none;
}
</style>

<div id="attachment-list"/>
<script>
$(function () {
    var first = true;
    $.getJSON("attachment/list/7822", function (files) {
        //console.dir(files);
        var html = "<table class=\"table table-condensed\">";
        $(files).each(function() {
            if(first) {
                first = false;
                html += "<legend class=\"noborder\">Attachmenets</legend>";
            }
            html += "<tr class=\"attachment\">";
            html += "<td><img src=\""+this.thumbnail_url+"\"/></td>";
            html += "<td><a href=\""+this.url+"\" target=\"_blank\">"+this.name+"</a></td>";
            html += "<td>"+bytesToSize(this.size, 1)+"</td>";
            html += "</tr>";
        });
        html += "</table>";
        $("#attachment-list").html(html);
    });
});

function download(url) {
    window.open(url, "_blank");
}
</script>


</div><!--span-->
</div><!--row-fluid-->


</form>

</div>
<div id="updates" style="clear: both;">
    <legend>Past Updates
    <div class="btn-toolbar pull-right toolbar">
        <div class="btn-group">
                <a class="btn btn-small" href="https://ticket.opensciencegrid.org/7822?sort=up&amp;"><i class="icon-arrow-up"></i> Sort</a>

        
        <a class="btn btn-small" href="https://ticket.opensciencegrid.org/7822?expandall=true&amp;">Expand Descriptions</a>        <a class="btn btn-small" target="_blank" href="mailto:osg@tick.globalnoc.iu.edu?subject=Open%20Science%20Grid%3A%20OSG%20Storage%26%2358%3B%20Xrootd%26%2358%3B%20Draining%20xrood%20server%20ISSUE%3D7822%20PROJ%3D71"><i class="icon-envelope"></i> Update w/Email</a>
        </div>
    </div><!--btn-toolbar-->
    </legend>

    <div class='update_description'><i onclick="document.location='7822#1260503347'; reset_anchor();" class="pull-right icon icon-share"></i><div class="header"><time datetime="2009-12-11T03:49:07+00:00">Dec 11, 2009 03:49 AM UTC</time> by <b>Neha Sharma</b><a class="anchor" name="1260503347">&nbsp;</a></div><pre>Hi Sarah,

I wasn&#39;t able to reproduce the problem. What release of xrootd are you
using? Does this happen to all files you tried this way?

What happens is that xrootdfs did a stat() (which made the redirector aware
of this file) then went to each data server to delete this file. The data
server should notify redirector that the file was deleted. It seems this
step didn&#39;t happen some how.

regards,
Wei Yang  |  yangw@....  |  650-926-3338(O)

From&#58; Sarah Williams &#60;saewill@....&#62;
Date&#58; Tue, 08 Dec 2009 16&#58;12&#58;07 -0500
Cc&#58; Wei Yang &#60;yangw@....&#62;, OSG STORAGE
&#60;osg-storage@....&#62;, MWT2 &#60;mwt2-core-l@....&#62;
Subject&#58; Re&#58; How to drain an xrootd data server

-----BEGIN PGP SIGNED MESSAGE-----
Hash&#58; SHA1

I&#39;ve got the files being copied in now by using cp and the preload
libraries. I&#39;m still pretty disturbed that using rm on the file in
xrootdfs left xrootd in an inconsistent state.

Sarah Williams wrote&#58;
Hi Wei,

I seem to be in a weird condition now ...

I deleted the list of files from xrootdfs. If I chose a test file and
look for it, it&#39;s deleted&#58;
[root@iut2-c141 conf]# ls -l
/xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35_pythia_jet_filter.merg
<div id='show_543476599' class=''><button class="btn">Show More</button></div><div class='detail hidden' id='detail_543476599'>e.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.root.1
ls&#58;
/xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35_pythia_jet_filter.merg
e.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.root.1&#58;
No such file or directory

However, if I try to copy it back in&#58;
[root@uct2-c024 xrdfs2]# /opt/xrootd/xrootd/bin/xrdcp
xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35_pythia_jet_filter.merge
.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.root.1
root&#58;//iut2-dc1.iu.edu//xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35
_pythia_jet_filter.merge.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.r
oot.1
Last server error 3011 (&#39;Unable to create new file; file already exists.&#39;)
Error accessing path/file for
root&#58;//iut2-dc1.iu.edu//xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35
_pythia_jet_filter.merge.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.r
oot.1

&#58;(

I thought maybe the file was still present on the redirector, but it
doesn&#39;t look like it&#58;
[root@iut2-dc1 logs]# ls
/xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35_pythia_jet_filter.merg
e.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.root.1
ls&#58;
/xrdfs/atlasmcdisk/groupmc08/AOD/groupmc08.105807.JF35_pythia_jet_filter.merg
e.AOD.e359_a84_t53_tid080364/AOD.080364._002001.pool.root.1&#58;
No such file or directory

Maybe the data server didn&#39;t get the message from the redirector that
the file was deleted?

--Sarah

Wei Yang wrote&#58;
Hi Sarah,

Another way that might work is to set the minimum required space on that
data server to be more than what it has&#58;

<a href='http&#58;//xrootd.slac.stanford.edu/doc/prod/cms_config.htm#_Toc238660928' target='_blank' rel='nofollow'>http&#58;//xrootd.slac.stanford.edu/doc/prod/cms_config.htm#_Toc238660928</a>

If you do so, xrootd redirector will think the data server run out of space
and will not direct future write to it, while still allow you to delete
files from it.

Then, you can get a list of files from the data server, copy a file out to
another temp location, delete it from xrootd cluster (which means from the
data server you are draining), and copy it back to the cluster. I supposed
in this last step, xrootd redirector will place the file to another data
server (need to verify).

regards,
Wei Yang  |  yangw@....  |  650-926-3338(O)

From&#58; Sarah Williams &#60;saewill@....&#62;
Date&#58; Tue, 08 Dec 2009 14&#58;14&#58;11 -0500
To&#58; Wei Yang &#60;yangw@....&#62;
Cc&#58; OSG STORAGE &#60;osg-storage@....&#62;, MWT2
&#60;mwt2-core-l@....&#62;
Subject&#58; Re&#58; How to drain an xrootd data server

Hi Wei,

I see what you mean.  The doc has an option &#39;migratable&#39;, which sounds
promising, but maybe has something to do with tape?

Here&#39;s my current plan for draining the server&#58;

Turn off bestman so new data can&#39;t be written into the system

On the data server, create a new dir with hardlinks to all the data files.

mkdir /dcache/xrdfs2 ; cd /dcache/xrdfs2
find /xrdfs -type l &#62;files.txt ;
cat files.txt | while read file; do echo ln $( readlink $file ) ./$file;
done &#62;ln.sh
sh ln.sh

Take files.txt to a node that has xrootdfs, and delete them
cat files.txt | while read file; do rm -f $file; done
# I should really be using xargs -P here ....

Go back to the data server, and use xrdcp or srmcp to copy the files  in
/dcache/xrdfs2 back into their old locations

I&#39;ll let you know if it works ;-)

--Sarah

Wei Yang wrote&#58;
Hi Sarah,

I guess this issue has never been brought up by Babar because SLAC has a
MSS... I will come out with some scripts to do this. The hard part is
that
one will need to set the draining data server as read-only, and if
someone
wants to delete files from that data server, then ...

See <a href='http&#58;//xrootd.slac.stanford.edu/doc/prod/ofs_config.htm#_Toc231732056' target='_blank' rel='nofollow'>http&#58;//xrootd.slac.stanford.edu/doc/prod/ofs_config.htm#_Toc231732056</a>
on
how to set a data server read-only.

regards,
Wei Yang  |  yangw@....  |  650-926-3338(O)

From&#58; Sarah Williams &#60;saewill@....&#62;
Date&#58; Tue, 08 Dec 2009 13&#58;14&#58;45 -0500
To&#58; OSG STORAGE &#60;osg-storage@....&#62;
Subject&#58; How to drain an xrootd data server

Hi all,

I need to remove one of the data servers from my xrootd test bed. I&#39;d
like to move the data from it to the other servers.  What&#39;s the best way
to do that - is there a supported way to drain an xrootd data server?
And, a related question, can you set a data server read-only?

--Sarah

- --
Sarah Williams
saewill@....
(317) 274-0595
<a href='http&#58;//pgp.mit.edu&#58;11371/pks/lookup?op=get&amp' target='_blank' rel='nofollow'>http&#58;//pgp.mit.edu&#58;11371/pks/lookup?op=get&amp</a>;search=0x3E6F7BBA
-----BEGIN PGP SIGNATURE-----
Version&#58; GnuPG v1.4.7 (Darwin)
Comment&#58; Using GnuPG with Mozilla - <a href='http&#58;//enigmail.mozdev.org/' target='_blank' rel='nofollow'>http&#58;//enigmail.mozdev.org/</a>

iD8DBQFLHsEn2j+lnz5ve7oRAoYLAKCorS28Q/7QL9iAaI5Pj4I44t3rmQCfTu56
lnwi+lxHprOkz0x72jHDoK8=
=1OiD
-----END PGP SIGNATURE-----
</div><script type='text/javascript'>
        $('#show_543476599').click(function() {
            $('#detail_543476599').slideDown("normal");
            $('#show_543476599').hide();
            $('#hide_543476599').show();
        });
        $('#hide_543476599').click(function() {
            $('#detail_543476599').slideUp();
            $('#hide_543476599').hide();
            $('#show_543476599').show();
        });
        </script></pre></div>
</div>
<script type="text/javascript">
function reset_anchor() {
    $("#updates .selected").removeClass("selected");
    var urls = document.location.toString().split('#'); 
    var anchor = urls[1];
    if(anchor) {
        $("a[name='"+anchor+"']").parents(".update_description").addClass("selected");
    }
}
function submitspam(ticket_id) {
    myret = confirm("Would you like to close this ticket as a security ticket, and submit the ticket content to akismet?");
    if(myret == true) {
        $.ajax("viewer/processspam?id="+ticket_id).done(function() {
            window.location.reload();
        });
    }
}

$(function() {
    reset_anchor();
    var ADDITIONAL_COOKIE_NAME = 'gocticket';
    var options = { path: '/', expires: 365};

    if(window.opener && window.opener.name == "gocticket_list") {
        v = $.cookie("closewindow");
        if(!v) {
            $("#closewindow").attr("checked", "checked"); //on by default
        } else {
            if(v == "checked") {
                $("#closewindow").attr("checked", "checked");
            }
        }
        $("#closewindow").click(function() {
            $.cookie("closewindow", $(this).attr('checked'), options);
        });
    } else {
        $("#closewindow_area").hide();
    }
    function updateTimeago() {
        $("time").timeago();
        setTimeout(updateTimeago, 30*1000);
    }
    updateTimeago();
    $(".description").focus(expand_description);
});
</script>
<hr/>
<footer>
<p>GOC Ticket Version 2.2 | <a href="https://ticket.opensciencegrid.org/goc/submit?app_issue_check=on&amp;app_issue_type=goc&amp;app_goc_url=https%3A%2F%2Fticket.opensciencegrid.org%3A443%2F7822">Report Bugs</a>
 | <a href="https://github.com/opensciencegrid/operations/blob/master/docs/privacy.md">Privacy Policy</a>
</p>

<p> <img align="top" src="images/tag_orange.png"/> Copyright 2018 The Trustees of Indiana University - Developed for Open Science Grid</p>
</footer>


</div><!--container-fluid-->
<script>
//used by searchbox
function parseValue(value) {
    var obj = new Object();
    var tokens = value.split("\t");
    obj.str = tokens[0];
    obj.count = tokens[1];
    return obj;
}

$(function() {
    //bootstrap-2.0.4 stuff
    $(".alert-message").alert();
    $(".dropdown-toggle").dropdown();
    $("span[rel='tooltip']").tooltip();
    $("a[rel=popover]").popover();

    //activate menu that user is currently on
    $("#menu_navigator").addClass("active"); 
    $("#submenu_").addClass("active"); 

    //translate zend validation error message to bootstrap
    $(".errors").addClass("alert").addClass("alert-error");

    //enable autocomplete for search box
    $("#search").autocomplete({
        source: function( request, response ) {
            $.ajax({
                url: "search/autocomplete",
                dataType: "text",
                data: {
                    //featureClass: "P",
                    //style: "full",
                    //maxRows: 12,
                    //name_startsWith: request.term
                    q: request.term
                },
                success: function( data ) {
                    response( $.map( data.split("\n"), function( item ) {
                        if(item == "") return null;
                        return {
                            value: item
                        }
                    }));
                }
            });
        },
        select: function(event, ui) {
            document.location = "search?q="+ui.item.value;
        }
    });
    
});
</script>


</body>
